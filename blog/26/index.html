
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Artsy Engineering</title>
  <meta name="author" content="">

  <link
    rel="stylesheet"
    type="text/css"
    href="https://webfonts.artsy.net/all-webfonts.css"
  />

  
  <meta name="description" content="
  
  
    
      
        

  
    
      
        
          
        
        
          Testing with Delayed Jobs
        
        
          
...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:image" content="http://artsy.github.io/images/artsy_oss_image.png" />
  <meta property="og:image:type" content="image/png" />

  
  <link rel="canonical" href="https://artsy.github.io/blog/26/">
  <link rel="alternate" type="application/rss+xml" title="Artsy Engineering Blog" href="/feed">
  <link rel="alternate" type="application/atom+xml" title="Podcast Feed" href="/podcast.xml" />

  <link href="/favicon.ico" rel="icon">
  <link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  <script src="/javascripts/jquery-1.11.3.min.js"> </script>
  <script src="/javascripts/gradient-fade.js"></script>
  <script src="/javascripts/noframework.waypoints.min.js"></script>
  <script src="/javascripts/sticky.min.js"></script>
  <script src="/javascripts/custom-element.min.js"></script>
  <script src="/javascripts/g-emoji-element.js"></script>
  <script src="/javascripts/related-articles.js"></script>

  

  <link href="/feed.xml" rel="alternate" title="Artsy Engineering" type="application/atom+xml">
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12450662-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
  <div id="logo-container">
    <a id="lrg-mark" href="https://www.artsy.net/">
      <svg viewBox="0 0 510 510" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
        <path transform="scale(1, -1) translate(0, -480)" d="M0 -32h512v512h-512v-512v0zM464 16h-80v80h-48v-80h-288v416h416v-416v0zM194 384h-40l-74 -186h38l20 52h72l19 -52h39l-74 186v0zM149 282l25 66l24 -66h-49v0z"/>
      </svg>
    </a>
  </div>
  <header id="banner"><div id="header">
  <div class="header-navigation">
    <ul>
      <li><a href="https://developers.artsy.net/">API</a></li>
      <li><a href="https://www.artsy.net/jobs">Careers</a></li>
      <li><a href="http://twitter.com/artsyopensource">@artsyopensource</a></li>
      <li><a href="http://www.artsy.net/">Artsy.net</a></li>
    </ul>
    <span class="header-section-title">
      
        <a href="/open-source">Open Source</a>
      
    </span>
  </div>

  <div class="header-sticky-container">
    <div class="header-logo">
      <h2><a href="https://artsy.github.io">Artsy</a></h2>
    </div>
    <div class="header-search">
      
        <h2><a href="/">Engineering Blog</a></h2>
      
    </div>
  </div>
</div>
</header>
  <div class="header-hamburger">
    <button class="cmn-toggle-switch cmn-toggle-switch__htx">
      <span>toggle menu</span>
    </button>
  </div>
  <div id="main">
    <div id="content">

      <div class="blog-index">
  
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/08/16/testing-with-delayed-jobs/">
        
        
          <h2 class="entry-title">Testing with Delayed Jobs</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/db">Daniel Doubrovkine<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/dblockdotorg">@dblockdotorg</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>A mean bug made it into our production environment. It wasn’t caught by our extensive test suite and caused thousands of emails to be sent to a handful of people. The root cause was an unfortunate combination of <a href="https://github.com/plataformatec/devise">Devise</a>, <a href="https://github.com/collectiveidea/delayed_job">DelayedJob</a> and, of course, our own code. It was an easy fix, but nobody ever wants this to happen again.</p>

<p>tl;dr DelayedJob says it’s possible to set <code class="language-plaintext highlighter-rouge">Delayed::Worker.delay_jobs = false</code> for your tests. Don’t do it.</p>


        <p><a href="/blog/2012/08/16/testing-with-delayed-jobs/">Read on →</a></p>
    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/08/14/on-objective-c-code-standards/">
        
        
          <h2 class="entry-title">On Our Objective-C Code Standards</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/orta">Orta Therox<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/orta">@orta</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>With the release of Xcode 4.4 I’ve taken a look back at our existing code standards and tried to come up with something that is cleaner and more elegant. Here are a few of the ideas I’ve been using to modernize the codebase.</p>

<h3 id="remove-private-method-declarations-and-use-class-extensions-to-add-ivars">Remove private method declarations and use class extensions to add ivars.</h3>

<p>First to get chopped by the deletion button are private method declarations. After Xcode 4.2 came out we took to using the class extension feature to add private method declarations at the top of implementation files. This was a nice way of keeping private methods out of the header files. Now that the compiler will check for pre-existing method signatures within the same object there’s no need to define their interfaces.</p>

<!--more-->

<p>Occasionally it’s necessary for subclass to know about private methods defined by its superclass, so we use a shared category to let them know what they respond to. Like Apple, we also quit using <code class="language-plaintext highlighter-rouge">@private</code> in header files.</p>

<p>Ivars now should go in class extensions, and be prefixed by an underscore. Apple advises that you don’t use method names with underscores but encourage underscored variable names. This also can free up method parameters from having ugly names such as anArtwork or aString.</p>

<h3 id="use-object-literals-when-possible">Use object literals when possible.</h3>

<p>Object literals are ways of adding syntacitcal sugar to the Objective-C language, they let you access keys and values easily on <code class="language-plaintext highlighter-rouge">NSDictionary</code>s and objects in <code class="language-plaintext highlighter-rouge">NSArray</code>s. There’s no reason to not be using them if you’re supporting iOS 4 and above. It’s simple a matter of <code class="language-plaintext highlighter-rouge">_artworks[2]</code> vs <code class="language-plaintext highlighter-rouge">[_artworks objectAtIndex:2]</code>.</p>

<h3 id="dot-syntax-is-ok-for-non-properties">Dot syntax is OK for non-properties.</h3>

<p>OK so, I admit it. I whined when properties came out. It was back in 2007 and the Objective-C was ranked 40th in the world, it’s now ranked <a href="http://www.tiobe.com/index.php/paperinfo/tpci/Objective-C.html">3nd most popular programming language.</a> Within timeframe, my opinion on the subject of properties changed also.</p>

<p>Originally when properties came out they exclusively were given the right to use dot notation on objects. This makes sense as they were created to provide public access to ivars which normally you can only access internally using the dot notation. With Xcode 4.3, that also changed. Now, if a method doesn’t have any arguments it can be called using dot notation. I’m in favour of using this. For me a good rule of thumb has been if a method returns something, dot notation is OK. For example, <code class="language-plaintext highlighter-rouge">_artworksArray.count</code> is fine whilst <code class="language-plaintext highlighter-rouge">_parsingOperation.stop</code> isn’t.</p>

<h3 id="keep-external-code-out-of-your-project">Keep external code out of your project.</h3>

<p>External, or vendored code should be kept out of the main body of your code. You can use CocoaPods to keep all that code in check and up-to-date. CocoaPods is a project that aims to be what bundler does for ruby projects, or npm for node. It will deal with your dependancies whilst you can concentrate on your own code. It will create a seperate Xcode project that handles all you dependancies leaving your project only as your own code.</p>

<h3 id="use-umbrella-imports">Use umbrella imports.</h3>

<p>To try and keep the amount of noise we have at the top of our implementation files we have started to reduce the number of <code class="language-plaintext highlighter-rouge">#import "ARModel.h"</code> lines we use. By creating a <code class="language-plaintext highlighter-rouge">Models.h</code> file and having that include all the models it means we can still have a look through the <code class="language-plaintext highlighter-rouge">#imports</code> at the top to get an idea of the connections between the objects as that will only show the important imports. These can optionally be moved into your precompiled header files.</p>

<h3 id="keep-your-code-clean">Keep your code clean.</h3>

<p>Whitespace can and does slowly accumulate at the line-endings of your code. You should make sure that the new preference for automatically trimming whitespace is turned on in the text editing section of Xcode’s preferences.</p>

<h3 id="iboutlets-should-probably-go-in-your-class-extensions">IBOutlets should probably go in your class extensions.</h3>

<p>With modern versions of Xcode, it doesn’t matter that your IBOutlets are defined in places other than in headers. As Objective-C developers, we’ve come a long way from having to repeatedly drag a .h from Xcode to Interface Builder, so maybe it’s time to rethink the idea that our interface outlets should be publicly accessible. My opinion is that a controller’s views are for the most part a private affair and that if you want to expose their functionality you do it through custom methods in the controller. There are some downsides to this, in that  initially you have to change to the implementation file when using hybrid view when connecting them.</p>

<p>These decisions have come from internal discussions and from watching many WWDC sessions on the topic. We highly recommend watching the following <a href="https://developer.apple.com/wwdc/">WWDC sessions</a>.</p>

<p><a href="https://developer.apple.com/videos/wwdc/2011/">WWDC 2011</a>: 105 Polishing Your App, 112 Writing Easy To Change Code and 322 - Objective-C Advancements in Depth.</p>

<p><a href="https://developer.apple.com/videos/wwdc/2012/">WWDC 2012</a>: 405 Modern Objective-C and 413 Migrating to Modern Objective-C</p>

    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/07/10/on-demand-jenkins-agents-with-amazon-ec2/">
        
        
          <h2 class="entry-title">On-Demand Jenkins Agents with Amazon EC2</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/joey">Joey Aghion<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/joeyAghion">@joeyAghion</a>
      </p>
      

    </div>
  

  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/frank">Frank MacReery<a/></span>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>The <a href="http://artsy.net">Artsy</a> team faithfully uses <a href="http://jenkins-ci.org">Jenkins</a> for continuous integration.
<a href="http://artsy.github.com/blog/2012/05/27/using-jenkins-for-ruby-and-ruby-on-rails-teams/">As we’ve described before</a>,
our Jenkins controller and 8 agents run on Linode. This arrangement has at least a few drawbacks:</p>

<ul>
  <li>Our Linode servers are manually configured. They require frequent maintenance, and inconsistencies lead to
surprising build failures.</li>
  <li>The fixed set of agents don’t match the pattern of our build jobs: jobs get backed up during the day, but servers
are mostly unused overnight and on weekends.</li>
</ul>

<p>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Amazon+EC2+Plugin">Amazon EC2 Plugin</a> allowed us to replace those
agents with a totally scripted environment. Now, agents are spun up in the cloud whenever build jobs need them.</p>


        <p><a href="/blog/2012/07/10/on-demand-jenkins-agents-with-amazon-ec2/">Read on →</a></p>
    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/07/05/spend-time-with-your-site/">
        
        
          <h2 class="entry-title">Spend Time With Your Site</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/joey">Joey Aghion<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/joeyAghion">@joeyAghion</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>Empathy with end users is critical when developing consumer-facing software. Many go <a href="http://innonate.com/2011/03/09/hackers-the-canon-of-consumer-facing-products/">even</a> <a href="http://www.uie.com/articles/self_design/">further</a> and argue that you should <em>be</em> your own user to effectively deliver the best experience.</p>

<blockquote>
  <p><em>I’d encourage anyone starting a startup to become one of its users, however unnatural it seems.</em></p>

  <p>— Paul Graham <a href="http://paulgraham.com/organic.html">Organic Startup Ideas</a></p>
</blockquote>

<p>In practice, though, this can be difficult:</p>

<ul>
  <li>As a developer, you’re just not representative of the intended audience.</li>
  <li>You’re [appropriately] focused on the product’s next iteration, while your audience is occupied with the current state.</li>
  <li>You spend countless hours focused on product details—of course it’s a challenge to empathize with a casual visitor’s first impression.</li>
</ul>

<h2 id="keeping-it-real">Keeping it Real</h2>

<p>We’ve tried some best practices to overcome these tendencies. User feedback is emailed to everyone in the company. Engineers share customer support responsibilities. But one simple tool has been surprisingly useful: we stole a page from the agile development handbook and built an <a href="http://alistair.cockburn.us/Information+radiator">information radiator</a>. Like a <a href="http://en.wikipedia.org/wiki/Kanban_board">kanban board</a>, news ticker, or <a href="https://demo.geckoboard.com/dashboard/B6782E562794C2F2/">analytics wall board</a>, our information radiator gives us an ambient awareness of end users’ experiences. How?</p>


        <p><a href="/blog/2012/07/05/spend-time-with-your-site/">Read on →</a></p>
    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/06/25/replacing-hashbang-routes-with-pushstate/">
        
        
          <h2 class="entry-title">Replacing #! Routes with PushState Using Backbone.js</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/gib">Gilbert Reimschüssel (gib)<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/greims">@greims</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <blockquote>
  <p>The only constant is change, continuing change, inevitable change, that is the dominant factor in society
[and web apps!] today. No sensible decision can be made any longer without taking into account not only
the world as it is, but the world as it will be.</p>

  <p>– Isaac Asimov</p>
</blockquote>

<h2 id="rip-">R.I.P #!</h2>

<p>It did not take us long to discover we shared the concerns of Twitter’s
<a href="http://danwebb.net/2011/5/28/it-is-about-the-hashbangs">Dan Webb on hashbang routes</a>,
but it was almost a year before we were able to remove them from Artsy. Here’s how it went down.</p>

<p>Artsy relies on the <a href="http://documentcloud.github.com/backbone/">Backbone.js</a> framework for our client application
which offers a solid pushState routing scheme. This includes a seamless hashtag fallback for
<a href="http://caniuse.com/#feat=history">browsers that don’t support the HTML5 History API</a> (looking at you IE 9).</p>

<p>The pushState routing is optional, but <em>“the world as it should be”</em> suggests we say “Yes!” (or true) to pushState.</p>
<div class="language-coffeescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Backbone</span><span class="p">.</span><span class="na">history</span><span class="p">.</span><span class="na">start</span><span class="p">({</span> <span class="na">pushState</span><span class="o">:</span> <span class="no">true</span> <span class="p">})</span>
</code></pre></div></div>


        <p><a href="/blog/2012/06/25/replacing-hashbang-routes-with-pushstate/">Read on →</a></p>
    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/05/30/restful-api-caching-with-garner/">
        
        
          <h2 class="entry-title">RESTful API Caching with Garner</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/db">Daniel Doubrovkine<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/dblockdotorg">@dblockdotorg</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>Implementing server-side RESTful API caching is hard. In a straightforward API all the expiry decisions can be made automatically based on the URL, but most real world APIs that add requirements around object relationships or user authorization make caching particularly challenging.</p>

<p>At <a href="http://goruco.com/">GoRuCo</a> we open-sourced <a href="http://github.com/artsy/garner">Garner</a>, a cache implementation of the concepts described in this post. To “garner” means to gather data from various sources and to make it readily available in one place, kind-of like a cache! Garner works today with the <a href="http://github.com/intridea/grape">Grape API framework</a> and the <a href="http://github.com/mongoid/mongoid">Mongoid ODM</a>. We encourage you to fork the project, extend our library to other systems and contribute your code back, if you find it useful.</p>

<p>Garner implements the Artsy API caching cookbook that has been tried by fire in production.</p>


        <p><a href="/blog/2012/05/30/restful-api-caching-with-garner/">Read on →</a></p>
    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/05/27/using-jenkins-for-ruby-and-ruby-on-rails-teams/">
        
        
          <h2 class="entry-title">Using Jenkins for Ruby and Ruby-on-Rails Teams</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/db">Daniel Doubrovkine<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/dblockdotorg">@dblockdotorg</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>The <a href="http://jenkins-ci.org">Jenkins CI</a> project has grown tremendously in the past few months. There’re now
hundreds of plugins and an amazing engaged community. Artsy is a happy user and proud contributor to this effort
with the essential <a href="https://wiki.jenkins-ci.org/display/JENKINS/AnsiColor+Plugin">jenkins-ansicolor plugin</a>,
eliminating boring console output since 2011.</p>

<p>We are a continuous integration, deployment and devops shop and have been using Jenkins for over a year now. We’ve
shared our experience at the <a href="http://www.cloudbees.com/juc2012.cb">Jenkins User Conference 2012</a> in
<a href="http://www.slideshare.net/dblockdotorg/graduating-to-jenkins-ci-for-rubyonrails-teams">a presentation</a>. This blog
post is an overview of how to get started with Jenkins for Ruby(-on-Rails) teams.</p>

<p><img src="Artsy Jenkins CI" alt="/images/2012-05-27-using-jenkins-for-ruby-on-rails-teams/jenkins.png" /></p>


        <p><a href="/blog/2012/05/27/using-jenkins-for-ruby-and-ruby-on-rails-teams/">Read on →</a></p>
    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/05/16/generating-automatic-plain-text-mime-parts-with-rails-actionmailer/">
        
        
          <h2 class="entry-title">Generating Automatic Plain Text MIME Parts with Rails ActionMailer</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/db">Daniel Doubrovkine<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/dblockdotorg">@dblockdotorg</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>E-mail is one of the most important ways to engage your users. And every time you touch a user’s inbox, it reflects on your brand. But getting email right has become increasing difficult due to the complexities introduced by the thousands of web-based, desktop and mobile mail clients. Email formatting is like the “Hunger Games” where the major players include online services such as GMail, Yahoo, Hotmail or AOL, desktop clients such as Outlook and a myriad mobile devices ranging from iPhone and Android to Blackberry.</p>

<p>To deal with this landscape, the MIME standard allows systems to send e-mail with multiple parts: <code class="language-plaintext highlighter-rouge">plain/text</code> for business-efficient devices such as the Blackberry, and <code class="language-plaintext highlighter-rouge">text/html</code> for web-based e-mail readers, such as GMail. Furthermore, <code class="language-plaintext highlighter-rouge">ActionMailer</code> supports multiple template formats: create an <code class="language-plaintext highlighter-rouge">.html.haml</code> template along with a <code class="language-plaintext highlighter-rouge">.txt.haml</code> template to generate both. We also know that <code class="language-plaintext highlighter-rouge">text/plain</code> email helps deliverability, but we believe a disproportionately small amount of text e-mails are actually read - the vast majority of devices are capable of parsing some HTML.</p>

<p>Is it possible to avoid having to maintain two separate templates without sacrificing deliverability? How can we inject a <code class="language-plaintext highlighter-rouge">text/plain</code> part into HTML e-mail that is both useful and “free”?</p>

<!--more-->

<p><code class="language-plaintext highlighter-rouge">ActionMailer::Base</code> defines an internal method called <code class="language-plaintext highlighter-rouge">collect_responses_and_parts_order</code> (<a href="http://apidock.com/rails/ActionMailer/Base/collect_responses_and_parts_order">#ref</a>), which iterates over templates and renders them. Let’s override that method and examine the contents of the generated parts.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">collect_responses_and_parts_order</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">responses</span><span class="p">,</span> <span class="n">parts_order</span> <span class="o">=</span> <span class="k">super</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
    <span class="p">[</span><span class="n">responses</span><span class="p">,</span> <span class="n">parts_order</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Each <code class="language-plaintext highlighter-rouge">response</code> is a MIME part with its boundary and the <code class="language-plaintext highlighter-rouge">parts_order</code> is the order in which the parts appear in the final e-mail. The <a href="http://www.ietf.org/rfc/rfc1341.txt">MIME RFC 1341</a> says that the parts must be generated in the increasing order of preference, ie. <code class="language-plaintext highlighter-rouge">text/html</code> content-type part last, provided you want it to be the preferred format of your email.</p>

<p>We can find whether the generated e-mail contains a <code class="language-plaintext highlighter-rouge">plain/text</code> part and otherwise generate one.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">html_part</span> <span class="o">=</span> <span class="n">responses</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">response</span><span class="o">|</span> <span class="n">response</span><span class="p">[</span><span class="ss">:content_type</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"text/html"</span> <span class="p">}</span>
<span class="n">text_part</span> <span class="o">=</span> <span class="n">responses</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">response</span><span class="o">|</span> <span class="n">response</span><span class="p">[</span><span class="ss">:content_type</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"text/plain"</span> <span class="p">}</span>
<span class="k">if</span> <span class="n">html_part</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">text_part</span>
  <span class="c1"># generate a text/plain part</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Generating the text part means stripping all HTML with links preserved. <a href="http://nokogiri.org/">Nokogiri</a> has a very convenient deep <code class="language-plaintext highlighter-rouge">traverse</code> iterator.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">body_parts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="n">html_part</span><span class="p">[</span><span class="ss">:body</span><span class="p">]).</span><span class="nf">traverse</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="nf">text?</span> <span class="n">and</span> <span class="o">!</span> <span class="p">(</span><span class="n">content</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">content</span> <span class="p">?</span> <span class="n">node</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">strip</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">).</span><span class="nf">blank?</span>
    <span class="n">body_parts</span> <span class="o">&lt;&lt;</span> <span class="n">content</span>
  <span class="k">elsif</span> <span class="n">node</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="s2">"a"</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">href</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="nf">attr</span><span class="p">(</span><span class="s2">"href"</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">href</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^https?:/</span><span class="p">)</span>
    <span class="n">body_parts</span> <span class="o">&lt;&lt;</span> <span class="n">href</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Once we have all the parts, assemble them, get rid of duplicate text and links, and re-insert into the email as a <code class="language-plaintext highlighter-rouge">text/plain</code> multipart block.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">responses</span><span class="p">.</span><span class="nf">insert</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
  <span class="ss">content_type: </span><span class="s2">"text/plain"</span><span class="p">,</span>
  <span class="ss">body: </span><span class="n">body_parts</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">parts_order</span><span class="p">.</span><span class="nf">insert</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"text/plain"</span>
</code></pre></div></div>

<p>This has been extracted into the <a href="https://github.com/dblock/actionmailer-text">actionmailer-text</a> gem. Include <code class="language-plaintext highlighter-rouge">ActionMailer::Text</code> in your mailers.</p>

    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/05/15/how-to-organize-over-3000-rspec-specs-and-retry-test-failures/">
        
        
          <h2 class="entry-title">How to Organize Over 3000 RSpec Specs and Retry Test Failures</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/db">Daniel Doubrovkine<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/dblockdotorg">@dblockdotorg</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>Having over three thousand RSpec tests in a single project has become difficult to manage. We chose to organize these into suites, somewhat mimicking our directory structure. And while we succeeded at making our Capybara integration tests more reliable (see <a href="/blog/2012/02/03/reliably-testing-asynchronous-ui-w-slash-rspec-and-capybara/">Reliably Testing Asynchronous UI with RSpec and Capybara</a>), they continue relying on finicky timeouts. To avoid too many false positives we’ve put together a system to retry failed tests. We know that a spec that fails twice in a row is definitely not a fluke!</p>

<p>Create a new Rake file in <code class="language-plaintext highlighter-rouge">lib/tasks/test_suites.rake</code> and declare an array of test suites.</p>

<p>``` ruby lib/tasks/test_suites.rake
  SPEC_SUITES = [
    { :id =&gt; :models, :pattern =&gt; “spec/models/<strong>/<em>_spec.rb” },
    { :id =&gt; :controllers, :pattern =&gt; “spec/controllers/**/</em>_spec.rb” },
    { :id =&gt; :views, :pattern =&gt; “spec/views/</strong>/*_spec.rb” }
  ]</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- more --&gt;
`RSpec::Core` contains a module called `RakeTask` that will programmatically create Rake tasks for you.

``` ruby lib/tasks/test_suites.rake
require 'rspec/core/rake_task'

namespace :test
  namespace :suite
    RSpec::Core::RakeTask.new("#{suite[:id]}:run") do |t|
      t.pattern = suite[:pattern]
      t.verbose = false
      t.fail_on_error = false
    end
  end
end
</code></pre></div></div>

<p>Run <code class="language-plaintext highlighter-rouge">rake -T</code> to ensure that the suites have been generated. To execute a suite, run <code class="language-plaintext highlighter-rouge">rake test:suite:models:run</code>. Having a test suite will help you separate spec failures and enables other organizations than by directory, potentially allowing you to tag tests across multiple suites.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rake spec:suite:models:run
rake spec:suite:controllers:run
rake spec:suite:views:run
</code></pre></div></div>

<p>Retrying failed specs has been a long requested feature in RSpec (see <a href="https://github.com/rspec/rspec-core/issues/456">#456</a>). A viable approach has been finally implemented by <a href="https://github.com/antifun">Matt Mitchell</a> in <a href="https://github.com/rspec/rspec-core/pull/596">#596</a>. There’re a few issues with that pull request, but two pieces have already been merged that make retrying specs feasible outside of RSpec.</p>

<ul>
  <li><a href="https://github.com/rspec/rspec-core/pull/610">#610</a>:
A fix for incorrect parsing input files specified via <code class="language-plaintext highlighter-rouge">-O</code>.</li>
  <li><a href="https://github.com/rspec/rspec-core/pull/614">#614</a>:
A fix for making the <code class="language-plaintext highlighter-rouge">-e</code> option cumulative, so that one can pass multiple example names to run.</li>
</ul>

<p>Both will appear in the 2.11.0 version of RSpec, in the meantime you have to point your <code class="language-plaintext highlighter-rouge">rspec-core</code> dependency to the latest version on Github.</p>

<p>``` ruby Gemfile
“rspec-core”, :git =&gt; “https://github.com/rspec/rspec-core.git”</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Don't forget to run `bundle update rspec-core`.

The strategy to retry failed specs is to output a file that contains a list of failed ones and to feed that file back to RSpec. The former can be accomplished with a custom logger. Create `spec/support/formatters/failures_formatter.rb`.

``` ruby spec/support/formatters/failures_formatter.rb
require 'rspec/core/formatters/base_formatter'

module RSpec
  module Core
    module Formatters
      class FailuresFormatter &lt; BaseFormatter

        # create a file called rspec.failures with a list of failed examples
        def dump_failures
          return if failed_examples.empty?
          f = File.new("rspec.failures", "w+")
          failed_examples.each do |example|
            f.puts retry_command(example)
          end
          f.close
        end

        def retry_command(example)
          example_name = example.full_description.gsub("\"", "\\\"")
          "-e \"#{example_name}\""
        end

      end
    end
  end
end
</code></pre></div></div>

<p>In order to use the formatter, we must tell RSpec to <code class="language-plaintext highlighter-rouge">require</code> it with <code class="language-plaintext highlighter-rouge">--require</code> and to use it with <code class="language-plaintext highlighter-rouge">--format</code>. We don’t want to lose our settings in <code class="language-plaintext highlighter-rouge">.rspec</code> either - all these options can be combined in the Rake task.</p>

<p>``` ruby lib/tasks/test_suites.rake
RSpec::Core::RakeTask.new(“#{suite[:id]}:run”) do |t|
  t.pattern = suite[:pattern]
  t.verbose = false
  t.fail_on_error = false
  t.spec_opts = [
    “–require”, “#{Rails.root}/spec/support/formatters/failures_formatter.rb”,
    “–format”, “RSpec::Core::Formatters::FailuresFormatter”,
    File.read(File.join(Rails.root, “.rspec”)).split(/\n+/).map { |l| l.shellsplit }
  ].flatten
end</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Once a file is generated, we can feed it back to RSpec in another task, called `suite:suite[:id]:retry`.

``` ruby lib/tasks/test_suites.rake
RSpec::Core::RakeTask.new("#{suite[:id]}:retry") do |t|
  t.pattern = suite[:pattern]
  t.verbose = false
  t.fail_on_error = false
  t.spec_opts = [
    "-O", File.join(Rails.root, 'rspec.failures'),
    File.read(File.join(Rails.root, '.rspec')).split(/\n+/).map { |l| l.shellsplit }
  ].flatten
end
</code></pre></div></div>

<p>Finally, lets combine the two tasks and invoke <code class="language-plaintext highlighter-rouge">retry</code> when the <code class="language-plaintext highlighter-rouge">run</code> task fails.</p>

<p><code class="language-plaintext highlighter-rouge">ruby lib/tasks/test_suites.rake
task "#{suite[:id]}" do
  rspec_failures = File.join(Rails.root, 'rspec.failures')
  FileUtils.rm_f rspec_failures
  Rake::Task["spec:suite:#{suite[:id]}:run"].execute
  unless $?.success?
    puts "[#{Time.now}] Failed, retrying #{File.read(rspec_failures).split(/\n+/).count} failure(s) in spec:suite:#{suite[:id]} ..."
    Rake::Task["spec:suite:#{suite[:id]}:retry"].execute
  end
end
</code></p>

<p>A complete version of our <code class="language-plaintext highlighter-rouge">test_suites.rake</code>, including a <code class="language-plaintext highlighter-rouge">spec:suite:all</code> task that executes all specs can be found <a href="https://gist.github.com/2597305">in this gist</a>. Our Jenkins CI runs <code class="language-plaintext highlighter-rouge">rake spec:suite:all</code>, with a much improved weather report since we started using this system.</p>

    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  
    
      <article>
        <div class="article-container">

  
    <div class="meta-container">
      <header>
        
          <a href="/blog/2012/05/11/on-making-it-personal-in-iOS-with-searchbars/">
        
        
          <h2 class="entry-title">On Making It Personal in iOS with Searchbars</h2>
        
        <time datetime=""></time>
          <p class="meta-author">


  

  
    <div class="meta">
      <span class="byline author vcard"><a href ="/author/orta">Orta Therox<a/></span>
      
      <p class="fn">
        <a href="https://twitter.com/orta">@orta</a>
      </p>
      

    </div>
  

</p>
          </a>
      </header>
    </div>
  

  <div class="content-container">
    
    
        <p>We make Folio, a pretty kick-ass iPad app that we give away to our partners to showcase their inventory at art fairs. Whilst making it we tried to ensure that all of the application fits in with the <a href="http://artsy.net">Artsy</a> website aesthetic, and recently the last natively styled control fell to our mighty code hammers. That was the <code class="language-plaintext highlighter-rouge">UISearchBar</code>.</p>

<p><img src="http://ortastuff.s3.amazonaws.com/images/custom_searchbar_example.jpg" alt="Screenshot of Artsy Folio" /></p>

<p>When displaying only search results in a table it makes a lot of sense to use Apple’s <code class="language-plaintext highlighter-rouge">UISearchDisplayController</code> as it handles a lot of edge cases for you. However the downside is that you lose some control over how the views interact.</p>

<p>The search bar was the only native control that actually made it into the version 1 release. This was mainly due to it requiring a bit of black magic in order to get it to work the way we wanted. So lets go through the code and rip it to pieces.</p>

<!--more-->

<p>First up, you’re going to want to make yourself a subclass of the <code class="language-plaintext highlighter-rouge">UISearchBar</code>, I’m going to be calling ours <code class="language-plaintext highlighter-rouge">ARSearchBar</code>. Here’s our public header.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ARSearchBar</span> <span class="p">:</span> <span class="nc">UISearchBar</span>

<span class="c1">// Called from The SearchDisplayController Delegate</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showCancelButton</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">show</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">cancelSearchField</span><span class="p">;</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>Inside the implementation file we declare private instance variables for keeping track of the textfield and the Cancel button. This is so we can avoid finding them in the view hierarchy when we want to change the frame it during resizing.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">ARSearchBar</span> <span class="p">(){</span>
    <span class="n">UITextField</span> <span class="o">*</span><span class="n">foundSearchTextField</span><span class="p">;</span>
    <span class="n">UIButton</span> <span class="o">*</span><span class="n">overlayCancelButton</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So, to look at setting the size we’ve found it easiest to deal with that in an overrode <code class="language-plaintext highlighter-rouge">setFrame</code> and setting the height of the new frame before it goes to the super class. As the search bar doesn’t change its height between state changes like text insertion it shouldn’t pose a problem to have it hardcoded.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setFrame</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span> <span class="p">{</span>
    <span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">ARSearchBarHeight</span><span class="p">;</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">setFrame</span><span class="p">:</span><span class="n">frame</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>What does pose a problem though is making sure that the subviews inside the search bar are positioned correctly with respect to the new height, this is amended in <code class="language-plaintext highlighter-rouge">layoutSubviews</code>. In our case the textfield should take up almost all of the search bar.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">layoutSubviews</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">layoutSubviews</span><span class="p">];</span>

    <span class="c1">// resize textfield</span>
    <span class="n">CGRect</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
    <span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">ViewHeight</span><span class="p">;</span>
    <span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ViewMargin</span><span class="p">;</span>
    <span class="n">frame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">ViewMargin</span><span class="p">;</span>
    <span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-=</span> <span class="n">ViewMargin</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next up is that we can’t access our <code class="language-plaintext highlighter-rouge">foundSearchField</code> because it’s not been found yet! Personally,  I’m a big fan of using nibs for everything ( and pretty pumped about Storyboards too ) so we do our searching in <code class="language-plaintext highlighter-rouge">awakeFromNib</code> .</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">awakeFromNib</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">awakeFromNib</span><span class="p">];</span>

    <span class="c1">// find textfield in subviews</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">count</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIView</span> <span class="o">*</span><span class="n">subview</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">i</span><span class="p">];</span>                
        <span class="k">if</span> <span class="p">([</span><span class="n">subview</span><span class="p">.</span><span class="n">class</span> <span class="nf">isSubclassOfClass</span><span class="p">:[</span><span class="n">UITextField</span> <span class="nf">class</span><span class="p">]])</span> <span class="p">{</span>
            <span class="n">foundSearchTextField</span> <span class="o">=</span> <span class="p">(</span><span class="n">UITextField</span> <span class="o">*</span><span class="p">)</span><span class="n">subview</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This gives us a textfield, next up we want to stylize it. The perfect place for this is just after finding the textfield that you use to search in.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">stylizeSearchTextField</span> <span class="p">{</span>
    <span class="c1">// Sets the background to a static black by removing the gradient view</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">count</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIView</span> <span class="o">*</span><span class="n">subview</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">i</span><span class="p">];</span>                

        <span class="c1">// This is the gradient behind the textfield</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">subview</span><span class="p">.</span><span class="n">description</span> <span class="nf">hasPrefix</span><span class="p">:</span><span class="s">@"&lt;UISearchBarBackground"</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">subview</span> <span class="nf">removeFromSuperview</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// now change the search textfield itself</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">borderStyle</span> <span class="o">=</span> <span class="n">UITextBorderStyleNone</span><span class="p">;</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">whiteColor</span><span class="p">];</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">background</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@""</span><span class="p">;</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">clearButtonMode</span> <span class="o">=</span> <span class="n">UITextFieldViewModeNever</span><span class="p">;</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">leftView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TextfieldLeftMargin</span><span class="p">,</span> <span class="mi">0</span><span class="p">)];</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">placeholder</span> <span class="o">=</span> <span class="s">@""</span><span class="p">;</span>
    <span class="n">foundSearchTextField</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nf">serifFontWithSize</span><span class="p">:</span><span class="n">ARFontSansLarge</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You might be wondering why we removed the placeholder text? We needed more control over the style and positioning of the placeholder text and the search icon. These are easily controlled by the UISearchDisplayController subclass rather than inside the custom search bar. This is also the place that we can deal with having our custom Cancel button.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">searchDisplayControllerWillBeginSearch</span><span class="p">:(</span><span class="n">UISearchDisplayController</span> <span class="o">*</span><span class="p">)</span><span class="nv">controller</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">searchBar</span> <span class="nf">showCancelButton</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span> <span class="nf">animations</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
        <span class="n">searchPlaceholderLabel</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">searchDisplayControllerWillEndSearch</span><span class="p">:(</span><span class="n">UISearchDisplayController</span> <span class="o">*</span><span class="p">)</span><span class="nv">controller</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">searchBar</span> <span class="nf">showCancelButton</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
    <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">2</span> <span class="nf">animations</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
        <span class="n">searchPlaceholderLabel</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The corresponding code for showing and hiding the Cancel button is here. We just animate it in and out by a distance of 80.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showCancelButton</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">show</span> <span class="p">{</span>
    <span class="n">CGFloat</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">show</span><span class="p">?</span> <span class="o">-</span><span class="n">CancelAnimationDistance</span> <span class="p">:</span> <span class="n">CancelAnimationDistance</span><span class="p">;</span>
    <span class="p">[</span><span class="n">UIView</span> <span class="nf">animateWithDuration</span><span class="p">:</span><span class="mi">0</span><span class="p">.</span><span class="mi">25</span> <span class="nf">animations</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
        <span class="n">overlayCancelButton</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectOffset</span><span class="p">(</span><span class="n">overlayCancelButton</span><span class="p">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The original Cancel button is something that we choose to keep around, rather than removing it form the view hierarchy, that’s so we can have our overlay Cancel button call its method instead of trying to replicate the cancel functionality ourselves.</p>

<p>To keep track of the Cancel button we need to know when its meant to appear, and when its meant to disappear. Because the Cancel button is created at runtime every time a search is started we need to
know when thats happening so we can hide it, we can do that by registering for <code class="language-plaintext highlighter-rouge">UITextFieldTextDidBeginEditingNotification</code> on the textfield once it’s been found. We do this in <code class="language-plaintext highlighter-rouge">awakeFromNib</code>.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="nf">defaultCenter</span><span class="p">]</span> <span class="nf">addObserver</span><span class="p">:</span><span class="n">self</span> <span class="nf">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">removeOriginalCancel</span><span class="p">)</span> <span class="n">name</span><span class="o">:</span><span class="n">UITextFieldTextDidBeginEditingNotification</span> <span class="n">object</span><span class="o">:</span><span class="n">foundSearchTextField</span><span class="p">];</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">removeOriginalCancel</span> <span class="p">{</span>
    <span class="c1">// remove the original button</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">count</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIView</span> <span class="o">*</span><span class="n">subview</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">i</span><span class="p">];</span>                
        <span class="k">if</span> <span class="p">([</span><span class="n">subview</span><span class="p">.</span><span class="n">class</span> <span class="nf">isSubclassOfClass</span><span class="p">:[</span><span class="n">UIButton</span> <span class="nf">class</span><span class="p">]])</span> <span class="p">{</span>
        	<span class="c1">// This is called every time a search is began,</span>
        	<span class="c1">// so make sure to get the right button!</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">subview</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">ViewHeight</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">subview</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally we have the styling of the button. I’ve summed it up here as a lot of it is very application specific.</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">createButton</span> <span class="p">{</span>
    <span class="n">ARFlatButton</span> <span class="o">*</span><span class="n">cancelButton</span> <span class="o">=</span> <span class="p">[</span><span class="n">ARFlatButton</span> <span class="nf">buttonWithType</span><span class="p">:</span><span class="n">UIButtonTypeCustom</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">cancelButton</span> <span class="nf">titleLabel</span><span class="p">]</span> <span class="nf">setFont</span><span class="p">:[</span><span class="n">UIFont</span> <span class="nf">sansSerifFontWithSize</span><span class="p">:</span><span class="n">ARFontSansSmall</span><span class="p">]];</span>

    <span class="n">NSString</span> <span class="o">*</span><span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s">@"Cancel"</span> <span class="nf">uppercaseString</span><span class="p">];</span>
    <span class="p">[</span><span class="n">cancelButton</span> <span class="nf">setTitle</span><span class="p">:</span><span class="n">title</span> <span class="nf">forState</span><span class="p">:</span><span class="n">UIControlStateNormal</span><span class="p">];</span>
    <span class="p">[</span><span class="n">cancelButton</span> <span class="nf">setTitle</span><span class="p">:</span><span class="n">title</span> <span class="nf">forState</span><span class="p">:</span><span class="n">UIControlStateHighlighted</span><span class="p">];</span>

    <span class="n">CGRect</span> <span class="n">buttonFrame</span> <span class="o">=</span> <span class="n">cancelButton</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>
    <span class="n">buttonFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">ViewMargin</span><span class="p">;</span>
    <span class="n">buttonFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">ViewHeight</span><span class="p">;</span>
    <span class="n">buttonFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span>
    <span class="n">buttonFrame</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">buttonFrame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">ViewMargin</span> <span class="o">+</span> <span class="n">CancelAnimationDistance</span><span class="p">;</span>
    <span class="n">cancelButton</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">buttonFrame</span><span class="p">;</span>
    <span class="p">[</span><span class="n">cancelButton</span> <span class="nf">addTarget</span><span class="p">:</span><span class="n">self</span> <span class="nf">action</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">cancelSearchField</span><span class="p">)</span> <span class="n">forControlEvents</span><span class="o">:</span><span class="n">UIControlEventTouchUpInside</span><span class="p">];</span>

    <span class="n">overlayCancelButton</span> <span class="o">=</span> <span class="n">cancelButton</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">addSubview</span><span class="p">:</span><span class="n">overlayCancelButton</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">bringSubviewToFront</span><span class="p">:</span><span class="n">overlayCancelButton</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">cancelSearchField</span> <span class="p">{</span>
    <span class="c1">// tap the original button!</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">count</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UIView</span> <span class="o">*</span><span class="n">subview</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">subviews</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">i</span><span class="p">];</span>                
        <span class="k">if</span> <span class="p">([</span><span class="n">subview</span><span class="p">.</span><span class="n">class</span> <span class="nf">isSubclassOfClass</span><span class="p">:[</span><span class="n">UIButton</span> <span class="nf">class</span><span class="p">]])</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">subview</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">ViewHeight</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">UIButton</span> <span class="o">*</span><span class="n">realCancel</span> <span class="o">=</span> <span class="p">(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="n">subview</span><span class="p">;</span>
                <span class="p">[</span><span class="n">realCancel</span> <span class="nf">sendActionsForControlEvents</span><span class="p">:</span> <span class="n">UIControlEventTouchUpInside</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>    
<span class="p">}</span>
</code></pre></div></div>

<p>The complete code is available <a href="https://gist.github.com/2667766">as a gist</a> under the MIT license.</p>

    

    
  </div>


  <footer>
  </footer>

</div>

      </article>
  

  <div class="pagination">
    <a href="/blog/archives">Blog Archives</a>
    <a href="/blog/categories">Categories</a>

    
      <a href="/blog/25/" class="previous">Previous</a>
    
    <span class="page_number ">Page: 26 of 28</span>

    
      <a href="/blog/27/" class="next">Older</a>
    
  </div>
</div>


    </div>

    <aside class="related-articles"></aside>

  </div>
  <footer id="main_footer"> <div class="footer-navigation">
  <ul>
    <li><a href="https://developers.artsy.net/">API</a></li>
    <li><a href="https://www.artsy.net/jobs">Careers</a></li>
    <li><a href="http://twitter.com/artsyopensource">@artsyopensource</a></li>
    <li><a href="http://www.artsy.net/">Artsy.net</a></li>
  </ul>
</div>



<script type="text/javascript">
      var disqus_shortname = 'artsy';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


</footer>
  <script type="text/javascript">
  $(function() {
    // TODO: Move this whole file to a javascript file that is included in the footer

    // Main sticky header
    if ($(window).width() >= 700) {
      var sticky = new Waypoint.Sticky({
        element: $("#banner"),
        offset: -100
      });
    }

    // Toggle hamburger menu
    $('.header-hamburger').click(function() {
      $('#banner, .cmn-toggle-switch').toggleClass('active');
      if (location.pathname == '/open-source') {
        $('#page-sidebar').toggle();
      }
    });
  });
</script>

</body>
</html>
