<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: testing | Artsy Engineering]]></title>
  <link href="https://artsy.github.io/blog/categories/testing/atom.xml" rel="self"/>
  <link href="https://artsy.github.io/"/>
  <updated>2024-03-13T21:40:57+00:00</updated>
  <id>https://artsy.github.io/</id>
  <author>
    <name><![CDATA[]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[What JavaScript Tests Could Learn From RSpec]]></title>
    <link href="https://artsy.github.io/blog/2021/09/10/what-javascript-tests-could-learn-from-rspec/"/>
    <updated>2021-09-10T00:00:00+00:00</updated>
    <id>https://artsy.github.io/blog/2021/09/10/what-javascript-tests-could-learn-from-rspec</id>
    <content type="html"><![CDATA[<p>When I started at Artsy a few years ago, I‚Äôd never written a line of Ruby. I feel at home with JavaScript ‚Äî it‚Äôs
been my buddy since I started my career over 20 years ago. I‚Äôve written enough tests in JavaScript that I sometimes
feel like I can write them in my sleep (as long as they don‚Äôt involve async React events üòÖ).</p>

<p>Most of the code I write at Artsy is still JavaScript, but now I write some Ruby code too, and I‚Äôve written enough
RSpec tests that I‚Äôm starting to form opinions about what I think they should look like.</p>

<p>My most recent work has been JavaScript again. I‚Äôve been writing Jest tests against one of our React apps. But
rather than reaching for the testing patterns I‚Äôd become accustomed to over my years of JavaScripting, I‚Äôm finding
that something‚Äôs missing in my Jest tests! My experiences with RSpec have me longing for two features in Jest:</p>

<!-- more -->

<ol>
  <li><code class="language-plaintext highlighter-rouge">context</code> blocks</li>
  <li><code class="language-plaintext highlighter-rouge">let</code> blocks</li>
</ol>

<h2 id="1-context-blocks">1. <code class="language-plaintext highlighter-rouge">context</code> blocks</h2>

<p>A <a href="https://relishapp.com/rspec/rspec-core/v/2-11/docs/example-groups/basic-structure-describe-it"><code class="language-plaintext highlighter-rouge">context</code> block</a>
in an RSpec test is, as I understand it, literally the same thing as a <code class="language-plaintext highlighter-rouge">describe</code> block. Like it‚Äôs just an alias of
<code class="language-plaintext highlighter-rouge">describe</code>. What‚Äôs the point, you ask?</p>

<p>The difference is in, well, context. Well-organized RSpec tests use <code class="language-plaintext highlighter-rouge">describe</code> to describe what‚Äôs being
tested‚Ä¶and <code class="language-plaintext highlighter-rouge">context</code> to describe scenarios of the thing being tested.</p>

<p>For example, if I wanted to test the <code class="language-plaintext highlighter-rouge">multiply</code> method of a <code class="language-plaintext highlighter-rouge">Calculator</code> class, I might write some test scenarios
that look like this:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"Calculator"</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s2">".multiply"</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s2">"when the first value is negative"</span> <span class="k">do</span>
      <span class="n">context</span> <span class="s2">"when the second value is negative"</span> <span class="k">do</span>
        <span class="n">it</span> <span class="s2">"returns a positive number"</span> <span class="k">do</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">context</span> <span class="s2">"when the second value is positive"</span> <span class="k">do</span>
        <span class="n">it</span> <span class="s2">"returns a negative number"</span> <span class="k">do</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>See the difference in those test cases between <code class="language-plaintext highlighter-rouge">describe</code> and <code class="language-plaintext highlighter-rouge">context</code>? The way I think about it is: if the
statement coming after my <code class="language-plaintext highlighter-rouge">describe</code>/<code class="language-plaintext highlighter-rouge">context</code> describes a pre-condition for the test, it‚Äôs a <code class="language-plaintext highlighter-rouge">context</code>; otherwise
it‚Äôs a <code class="language-plaintext highlighter-rouge">describe</code>.</p>

<p><code class="language-plaintext highlighter-rouge">context</code> wouldn‚Äôt be hard to implement in JavaScript ‚Äî I‚Äôd bet there are test frameworks that have it. It‚Äôd just
be an alias of <code class="language-plaintext highlighter-rouge">describe</code>.</p>

<h2 id="2-let-blocks">2. <code class="language-plaintext highlighter-rouge">let</code> blocks</h2>

<p><a href="https://relishapp.com/rspec/rspec-core/v/2-11/docs/helper-methods/let-and-let"><code class="language-plaintext highlighter-rouge">let</code> blocks</a> are used in an RSpec
test to set things up for your test scenario.</p>

<p>Here‚Äôs a test for a <code class="language-plaintext highlighter-rouge">Counter</code> class, verifying that when I call the <code class="language-plaintext highlighter-rouge">increment</code> method on an instance, its stored
value becomes <code class="language-plaintext highlighter-rouge">1</code>.</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"counter"</span> <span class="k">do</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:counter</span><span class="p">)</span> <span class="p">{</span> <span class="no">Counter</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">"increment"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"increments by 1"</span> <span class="k">do</span>
      <span class="n">counter</span><span class="p">.</span><span class="nf">increment</span>

      <span class="n">counter</span><span class="p">.</span><span class="nf">value</span><span class="p">.</span><span class="nf">should</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you‚Äôre new to Ruby, the only line that doesn‚Äôt translate almost directly to a similar JavaScript expression is
the <code class="language-plaintext highlighter-rouge">let</code> statement.</p>

<p>The <code class="language-plaintext highlighter-rouge">let</code> statement in RSpec <a href="https://medium.com/@tomkadwill/all-about-rspec-let-a3b642e08d39">creates a method with a specified name, which lazily evaluates to the result of a
block</a>. In this case, we get a method named <code class="language-plaintext highlighter-rouge">counter</code>, which is evaluated to a new instance of the
<code class="language-plaintext highlighter-rouge">Counter</code> class. There are a few important things to note about <code class="language-plaintext highlighter-rouge">let</code> blocks:</p>

<ol>
  <li>They‚Äôre evaluated lazily (by default). That <code class="language-plaintext highlighter-rouge">counter</code> doesn‚Äôt actually get created until I reference it.</li>
  <li>They‚Äôre memoized. Wherever I reference <code class="language-plaintext highlighter-rouge">counter</code> within that <code class="language-plaintext highlighter-rouge">describe "counter"</code> block, I‚Äôm getting the same
instance. It‚Äôs initialized to whatever I return inside the <code class="language-plaintext highlighter-rouge">let</code> block.</li>
  <li>I can override a <code class="language-plaintext highlighter-rouge">let</code> block deeper inside the tree of tests, by declaring another <code class="language-plaintext highlighter-rouge">let(:counter)</code> later. When I
do this, the closest <code class="language-plaintext highlighter-rouge">let</code> block in the tree for that thing is the one that gets used.</li>
</ol>

<p>I don‚Äôt think it‚Äôs possible to implement <code class="language-plaintext highlighter-rouge">let</code> in JavaScript ‚Äî at least not in the way it exists in RSpec. It
relies on
<a href="https://www.leighhalliday.com/ruby-metaprogramming-method-missing">Ruby meta-programming to intercept calls to missing methods</a>,
which just doesn‚Äôt exist in JavaScript. The <a href="https://github.com/enova/givens">givens</a> library does something pretty
close, but it relies on string keys to define things, and there‚Äôs a bit of extra work when working with TypeScript.</p>

<h2 id="whats-the-big-deal">What‚Äôs the big deal?</h2>

<p>On the surface these two features don‚Äôt seem like much, but they provide a really powerful framework for organizing
test cases and the associated test setup.</p>

<p>With the <code class="language-plaintext highlighter-rouge">let</code> blocks being lazily evaluated, and override-able, I can set up data at the exact level of tests that
I need it. When I need to override it for a certain set of tests, I can put another <code class="language-plaintext highlighter-rouge">let</code> block in that set. In
JavaScript I can define functions to set up my data for me with just the changes I need at each test level, or I
can use <code class="language-plaintext highlighter-rouge">beforeEach</code> blocks, but all that can get pretty noisy.</p>

<p>And with <code class="language-plaintext highlighter-rouge">context</code> blocks, I can more clearly lay out the scenarios of my tests. Yes, I <em>could</em> just do this with
more <code class="language-plaintext highlighter-rouge">describe</code> blocks in JavaScript, but how often have you found JavaScript tests that actually do this? I‚Äôve
personally seen/written too many tests to count named something like
<code class="language-plaintext highlighter-rouge">it("returns false when the flag is enabled, they're located in the US, but they have brown hair.")</code>. That‚Äôs three
scenarios rolled into one test name. It works, but being able to nest different <code class="language-plaintext highlighter-rouge">context</code> blocks to define my
complex scenarios is much easier to read.</p>

<h2 id="examples">Examples</h2>

<p>Here‚Äôs an example of some tests I could write in RSpec with <code class="language-plaintext highlighter-rouge">let</code> and <code class="language-plaintext highlighter-rouge">context</code>:</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">describe</span> <span class="s2">"Calculator"</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:calculator</span><span class="p">)</span> <span class="p">{</span> <span class="no">Calculator</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

  <span class="n">describe</span> <span class="s2">".multiply"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:result</span><span class="p">)</span> <span class="p">{</span> <span class="n">calculator</span><span class="p">.</span><span class="nf">multiply</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">context</span> <span class="s2">"when the first value is negative"</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:first</span><span class="p">)</span> <span class="p">{</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span>

      <span class="n">context</span> <span class="s2">"when the second value is negative"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:second</span><span class="p">)</span> <span class="p">{</span> <span class="o">-</span><span class="mi">3</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">"returns a positive number"</span> <span class="k">do</span>
          <span class="n">result</span><span class="p">.</span><span class="nf">should</span> <span class="n">eq</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">context</span> <span class="s2">"when the second value is positive"</span> <span class="k">do</span>
        <span class="n">let</span><span class="p">(</span><span class="ss">:second</span><span class="p">)</span> <span class="p">{</span> <span class="mi">3</span> <span class="p">}</span>

        <span class="n">it</span> <span class="s2">"returns a negative number"</span> <span class="k">do</span>
          <span class="n">result</span><span class="p">.</span><span class="nf">should</span> <span class="n">eq</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>HOW COOL IS THAT! Every <code class="language-plaintext highlighter-rouge">describe</code>/<code class="language-plaintext highlighter-rouge">context</code> block has <em>exactly</em> the setup data it needs defined clearly inside it.
And each block has very little noise to distract you.</p>

<p>Here‚Äôs what I‚Äôd do in JavaScript/Jest to accomplish something similar:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Calculator</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">calculator</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Calculator</span><span class="p">()</span> <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">.multiply</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">first</span><span class="p">,</span> <span class="nx">second</span>
    <span class="kd">function</span> <span class="nx">getResult</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">calculator</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">second</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">when the first value is negative</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">first</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">})</span>

      <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">when the second value is negative</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">second</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="p">})</span>

        <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">returns a positive number</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">getResult</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">})</span>

      <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">when the second value is positive</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">second</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">})</span>

        <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">returns a negative number</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">expect</span><span class="p">(</span><span class="nx">getResult</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="p">})</span>
      <span class="p">})</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>There‚Äôs definitely a bit more noise here, especially with the <code class="language-plaintext highlighter-rouge">beforeEach</code> and <code class="language-plaintext highlighter-rouge">let</code> statements. It‚Äôs not a <em>lot</em>
more noise, but it is definitely more noise.</p>

<p>In real life I wouldn‚Äôt expect to find tests like the above JavaScript example. I‚Äôd expect to find the tests in
JavaScript looking more like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">Calculator</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">calculator</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Calculator</span><span class="p">()</span> <span class="p">})</span>

  <span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">.multiply</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">returns a positive number when the first number is negative and the second number is negative</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">calculator</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">returns a negative number when the first number is negative and the second number is positive</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">calculator</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

      <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>You could certainly make the case for this contrived example that <em>this</em> is actually the most readable set of
tests, because there‚Äôs less code. I would have a hard time arguing. But most real-life tests are more complex than
these examples, with state and side-effects to mock out, and more scenarios and edge cases worth testing. Each test
case here includes multiple conditions, but there are only two permutations represented. Once things get a little
more complicated than these contrived examples, the RSpec tests become the clear winner for me ‚Äî they‚Äôre easier to
read and manage, with their <code class="language-plaintext highlighter-rouge">let</code> and <code class="language-plaintext highlighter-rouge">context</code> blocks more discretely describing your test scenarios.</p>

<p>You could also argue that the bigger win here would be breaking scenarios into individual <code class="language-plaintext highlighter-rouge">describe</code> blocks in
JavaScript tests, instead of cramming the entire scenario into one long <code class="language-plaintext highlighter-rouge">it("...")</code> statement. I wouldn‚Äôt argue
that either.</p>

<h2 id="caveats">Caveats</h2>

<p>The day after I wrote this article, a conversation started in the Artsy slack about how confusing <code class="language-plaintext highlighter-rouge">let</code> was because
it moved variable initializations far away from where the tests used them.</p>

<p>This makes sense! I think it points to two truths in software development:</p>

<h3 id="code-readability-is-subjective">Code readability is subjective</h3>

<p>For years I was convinced that practices like small functions or long and descriptive function names were
<em>objectively</em> more readable. I leaned into this, and my code reviews almost always included comments on what I
thought would make the code more readable.</p>

<p>As more people pushed back on my feedback over time, I realized that the feedback I was giving was <em>subjective</em>. I
still like code that uses many short functions wired together, but not everyone finds that more readable! I‚Äôve
stopped giving readability feedback on PRs, unless I can provide nearly-objective facts or scenarios that point to
a readability improvement.</p>

<p>In this article, I find the RSpec <code class="language-plaintext highlighter-rouge">let</code> examples to be much more readable than the JavaScript examples. But you and
your team might not! Maybe the distance between a <code class="language-plaintext highlighter-rouge">let</code> block‚Äôs definition and its method‚Äôs usage makes it hard for
you to follow the test. That‚Äôs cool!</p>

<h3 id="any-cool-thing-can-be-abused">Any cool thing can be abused</h3>

<p>Earlier in this article I linked to <a href="https://medium.com/@tomkadwill/all-about-rspec-let-a3b642e08d39">an article that describes <code class="language-plaintext highlighter-rouge">let</code> blocks in more detail</a>. It includes
<a href="https://www.rubydoc.info/github/rspec/rspec-core/RSpec%2FCore%2FMemoizedHelpers%2FClassMethods%3Alet">a warning from the actual <code class="language-plaintext highlighter-rouge">let</code> docs</a>:</p>

<blockquote>
  <p>Note: <code class="language-plaintext highlighter-rouge">let</code> can enhance readability when used sparingly (1,2, or maybe 3 declarations) in any given example
group, but that can quickly degrade with overuse. YMMV.</p>
</blockquote>

<p>I‚Äôve definitely seen code where I had a hard time following a stream of <code class="language-plaintext highlighter-rouge">let</code> blocks. The RSpec example I gave
above reads nicely to me ‚Äî but it‚Äôs probably teetering on the edge of where <code class="language-plaintext highlighter-rouge">let</code> usage becomes confusing. I‚Äôm
guessing I have a slightly higher tolerance for this particular abstraction than my friends who don‚Äôt like
it‚Ä¶again pointing to readability being subjective.</p>

<p>Having said all that ‚Äî lately every time I try to write JavaScript tests, I find myself trying (unsuccessfully) to
recreate that RSpec example above. It represents exactly how I want to think about complex test scenarios. Each
level of the tests has exactly the setup that is unique to that level. There‚Äôs very little distraction or noise at
each <code class="language-plaintext highlighter-rouge">context</code> and <code class="language-plaintext highlighter-rouge">it</code>. It totally aligns with
<a href="https://www.stevenhicks.me/blog/2018/01/chekhovs-gun-and-better-unit-tests/">my desire to minimize irrelevant test setup</a>.
I‚Äôm in ‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è ‚ù§Ô∏è.</p>

<blockquote>
  <p><em>This post originally appeared on
<a href="https://www.stevenhicks.me/blog/2021/09/what-javascript-tests-could-learn-from-rspec/">Steve‚Äôs blog</a>.</em></p>
</blockquote>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing React Tracking with Jest and Enzyme]]></title>
    <link href="https://artsy.github.io/blog/2021/04/15/testing-react-tracking-with-jest-and-enzyme/"/>
    <updated>2021-04-15T00:00:00+00:00</updated>
    <id>https://artsy.github.io/blog/2021/04/15/testing-react-tracking-with-jest-and-enzyme</id>
    <content type="html"><![CDATA[<p>Recently, I needed to test a button that would make an analytics tracking call using
<a href="https://github.com/NYTimes/react-tracking">react-tracking</a> and then navigate to a new page in a callback. This
presented some challenges - I wasn‚Äôt sure how to create a mocked version of react-tracking that would allow a
callback to be passed.</p>

<p>With some help from fellow Artsy engineers <a href="https://github.com/damassi">Christopher Pappas</a> and
<a href="https://twitter.com/pvinis">Pavlos Vinieratos</a>, I got the tracking and testing to work. Here‚Äôs how we did it.</p>

<!-- more -->

<h1 id="a-little-context">A little context</h1>

<p>This work took place in Volt, our partner CMS (it‚Äôs sadly a private repository, but I‚Äôll do my best to paste in
relevant code snippets so you‚Äôre not totally in the dark). Volt has been around for a long time and has had several
different client-side tracking implementations over the years. In this case, I wanted to take the opportunity to
bring Volt up to standard with our other big apps, <a href="https://github.com/artsy/force/">Force</a> and
<a href="https://github.com/artsy/eigen">Eigen</a>. They both use react-tracking and
<a href="https://github.com/artsy/cohesion/">Cohesion</a>, our centralized analytics schema.</p>

<p>Our use-case was a button that would navigate the user to a new page. The button had been implemented in a previous
PR, and now we wanted to make it execute a tracking call before navigating.</p>

<p>We use Segment for tracking, and their tracking setup relies on a JS snippet being available on your pages. That
snippet sets a <code class="language-plaintext highlighter-rouge">window.analytics</code> property, which in turn
<a href="https://segment.com/docs/connections/sources/catalog/libraries/website/javascript/#track">has a</a> <code class="language-plaintext highlighter-rouge">.track()</code>
method. On a fundamental level, all of our tracking calls boil down to a call to <code class="language-plaintext highlighter-rouge">window.analytics.track()</code>. We
pass a list of properties to <code class="language-plaintext highlighter-rouge">.track()</code>, Segment receives the event and properties, and the resulting JSON is
stored in our data warehouse.</p>

<h1 id="adding-react-tracking">Adding react-tracking</h1>

<p>First, there was a bit of setup required to get react-tracking working. The react-tracking package
<a href="https://github.com/NYTimes/react-tracking#custom-optionsdispatch-for-tracking-data">assumes you‚Äôre using Google Tag Manager by default</a>,
but allows you to override that behavior with a custom <code class="language-plaintext highlighter-rouge">dispatch</code> function. In our case, we wrap our React apps in
a <code class="language-plaintext highlighter-rouge">&lt;BaseApp&gt;</code> component, so we added a new <code class="language-plaintext highlighter-rouge">&lt;TrackerContextCohesion&gt;</code> component with a custom <code class="language-plaintext highlighter-rouge">dispatch</code> that would
be available to all of our React apps:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">track</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-tracking</span><span class="dl">"</span>

<span class="c1">// We're following the instructions from react-tracking's README on overriding the dispatch function</span>
<span class="kd">const</span> <span class="nx">TrackerContextCohesion</span> <span class="o">=</span> <span class="nx">track</span><span class="p">(</span>
  <span class="c1">// This is blank because we're not actually tracking a specific event here, just modifying dispatch</span>
  <span class="c1">// so that all components in the tree can use it</span>
  <span class="p">{},</span>
  <span class="p">{</span>
    <span class="na">dispatch</span><span class="p">:</span> <span class="p">({</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">trackEvent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">analytics</span><span class="p">.</span><span class="nx">track</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">))</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">)((</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">props</span><span class="p">.</span><span class="nx">children</span>
<span class="p">})</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">BaseApp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">TrackerContextCohesion</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/TrackerContextCohesion</span><span class="err">&gt;
</span><span class="p">}</span>
</code></pre></div></div>

<p>This allows us to make tracking calls in our components, including the passing of custom callback functions:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">useTracking</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-tracking</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Box</span><span class="p">,</span> <span class="nx">Button</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@artsy/palette</span><span class="dl">"</span>

<span class="c1">// Assumes that MyComponent is wrapped in &lt;BaseApp&gt; wherever it's used, giving</span>
<span class="c1">// it access to tracking context</span>
<span class="kd">const</span> <span class="nx">MyComponent</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">trackEvent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useTracking</span><span class="p">()</span>

  <span class="kd">const</span> <span class="nx">handleClick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">trackEvent</span><span class="p">({</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">action</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Click</span><span class="dl">"</span><span class="p">,</span> <span class="na">somePropToTrack</span><span class="p">:</span> <span class="dl">"</span><span class="s2">andy-warhol</span><span class="dl">"</span> <span class="p">},</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{},</span> <span class="c1">// Additional Segment options, e.g. integrations: { 'Intercom': false, }</span>
      <span class="na">callback</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="dl">"</span><span class="s2">/artworks</span><span class="dl">"</span><span class="p">)</span>
      <span class="p">},</span>
    <span class="p">})</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">Box</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">Button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">handleClick</span><span class="p">}</span><span class="o">&gt;</span><span class="nx">Track</span> <span class="nx">and</span> <span class="nx">navigate</span><span class="o">&lt;</span><span class="sr">/Button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/Box</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Being able to pass a callback was especially important in our case. We realized that if we needed to track <em>and
then navigate</em>, the callback was necessary. In our testing, we saw that if we simply tried to fire the tracking
call then run <code class="language-plaintext highlighter-rouge">window.location.assign()</code> synchronously, the tracking call might not get executed before the
navigation started, so we would effectively lose that event. Segment specifically
<a href="https://segment.com/docs/connections/sources/catalog/libraries/website/javascript/#track">allows you to pass a callback</a>
to their tracking function to their track function for this situation. They describe the optional <code class="language-plaintext highlighter-rouge">callback</code>
parameter as:</p>

<blockquote>
  <p>A function that is executed after a short timeout, giving the browser time to make outbound requests first.</p>
</blockquote>

<p>Thus, we pass the tracking data and the callback to the custom <code class="language-plaintext highlighter-rouge">track</code> call we implemented, and we‚Äôre good to go.</p>

<h1 id="the-problem-with-testing">The problem with testing</h1>

<p>Our use-case is simple enough, but we wanted to make sure that when the button was pressed, we would both execute
the tracking call and then navigate. A test checking that the navigation worked had already been implemented.
However, after moving the <code class="language-plaintext highlighter-rouge">window.location.assign</code> call into a callback, our test started failing because our
component was trying to execute a tracking call before navigating.</p>

<p>The test that predated the addition of tracking looked like this:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">enzyme</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">MyComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./MyComponent</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">TestApp</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">testing/components/TestApp</span><span class="dl">"</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">assign</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">Navigates to artworks page</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">TestApp</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">MyComponent</span> <span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="sr">/TestApp</span><span class="err">&gt;
</span>  <span class="p">)</span>

  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">"</span><span class="s2">Button</span><span class="dl">"</span><span class="p">).</span><span class="nx">simulate</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">assign</span><span class="p">).</span><span class="nx">toBeCalledWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">/artworks</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>So we were rendering our button, clicking on it, and expecting to try to navigate. How could we mock our tracking
call while still executing a passed callback?</p>

<h1 id="the-final-solution">The final solution</h1>

<p>Our mock ended up looking like this:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">analytics</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">track</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(),</span>
<span class="p">}</span>

<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">"</span><span class="s2">react-tracking</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">useTracking</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(),</span>
  <span class="na">track</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">children</span><span class="p">,</span>
<span class="p">}))</span>

<span class="kd">const</span> <span class="nx">trackEvent</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">((</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">callback</span><span class="p">()</span>
<span class="p">})</span>

<span class="nx">useTracking</span><span class="p">.</span><span class="nx">mockImplementation</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="nx">trackEvent</span><span class="p">,</span>
<span class="p">}))</span>
</code></pre></div></div>

<p>Let‚Äôs break that down section by section. First:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">analytics</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">track</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As noted above, all of our tracking calls assume <code class="language-plaintext highlighter-rouge">window.analytics</code> exists and that it has a <code class="language-plaintext highlighter-rouge">.track()</code> method. We
started by mocking that setup.</p>

<p>Next:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">"</span><span class="s2">react-tracking</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">useTracking</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">(),</span>
  <span class="na">track</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">children</span><span class="p">,</span>
<span class="p">}))</span>
</code></pre></div></div>

<p>Here we mock the <code class="language-plaintext highlighter-rouge">react-tracking</code> package and two specific methods it exports, <code class="language-plaintext highlighter-rouge">useTracking</code> and <code class="language-plaintext highlighter-rouge">track</code>. We made
<code class="language-plaintext highlighter-rouge">useTracking</code> a Jest function - we‚Äôll flesh it out further a few lines farther down in the file.</p>

<p>Then there‚Äôs the mocking of <code class="language-plaintext highlighter-rouge">track</code>. To put it in words, our mock is: a function that returns a function that takes
in <code class="language-plaintext highlighter-rouge">children</code> and returns those <code class="language-plaintext highlighter-rouge">children</code>. That might sound like gibberish at first blush, but essentially what
we‚Äôre doing is mocking the function composition we performed earlier when creating <code class="language-plaintext highlighter-rouge">TrackerContextCohesion</code>. We
needed something that was the same shape as <code class="language-plaintext highlighter-rouge">react-tracking</code>‚Äôs <code class="language-plaintext highlighter-rouge">track()</code>, but we don‚Äôt care about overriding
<code class="language-plaintext highlighter-rouge">dispatch</code> in our mocks.</p>

<p>Last:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">trackEvent</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">((</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">args</span><span class="p">.</span><span class="nx">callback</span><span class="p">()</span>
<span class="p">})</span>
<span class="nx">useTracking</span><span class="p">.</span><span class="nx">mockImplementation</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="nx">trackEvent</span><span class="p">,</span>
<span class="p">}))</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">trackEvent</code> is a mock function that takes in an <code class="language-plaintext highlighter-rouge">args</code> object and executes <code class="language-plaintext highlighter-rouge">args.callback()</code>. We then update our
<code class="language-plaintext highlighter-rouge">useTracking</code> mock to make it return a function that returns an object with a <code class="language-plaintext highlighter-rouge">trackEvent</code> property. What a
mouthful! That sounds super confusing, but remember that we‚Äôre trying to mock something that we actually use like
this:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">trackEvent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useTracking</span><span class="p">()</span>
</code></pre></div></div>

<p>So basically, our goal was to mock <code class="language-plaintext highlighter-rouge">trackEvent</code> and we needed to emulate the shape it has when it‚Äôs exported by
<code class="language-plaintext highlighter-rouge">react-tracking</code>. Hopefully that makes things a little clearer.</p>

<p>After some tinkering and eventually getting the mocks to work in a single test file, we moved these mocked
functions to a <code class="language-plaintext highlighter-rouge">setup.ts</code> file that all of our Jest tests load automatically. We chose to make these mocks
available to all tests because then we wouldn‚Äôt get surprising test failures if we, say, forgot that we were making
a tracking call in a component and didn‚Äôt explicitly mock the tracking calls in those tests.</p>

<p>At the end of the day, we can use these mocked calls in our test files by doing the following:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">enzyme</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">MyComponent</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./MyComponent</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">TestApp</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">testing/components/TestApp</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">useTracking</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-tracking</span><span class="dl">"</span>

<span class="c1">// This only works because we mock tracking in setup.ts, and we only need to</span>
<span class="c1">// declare it because we want to check how many times it was called. Also, it</span>
<span class="c1">// would break the rules of hooks (https://reactjs.org/docs/hooks-rules.html)</span>
<span class="c1">// if it wasn't mocked. Tread cautiously!</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">trackEvent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useTracking</span><span class="p">()</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">assign</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>

<span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">Calls tracking and navigates to artworks page</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">TestApp</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">MyComponent</span> <span class="p">{...</span><span class="nx">props</span><span class="p">}</span> <span class="sr">/</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/TestApp</span><span class="err">&gt;
</span>  <span class="p">)</span>

  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">"</span><span class="s2">Button</span><span class="dl">"</span><span class="p">).</span><span class="nx">simulate</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">trackEvent</span><span class="p">).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">assign</span><span class="p">).</span><span class="nx">toBeCalledWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">/artworks</span><span class="dl">"</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>That‚Äôs it! If you‚Äôre trying to test something similar and found this post, I hope it helps you out. If so, or if
you‚Äôre still confused, leave a comment!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Switch from Capybara Webkit to Chrome]]></title>
    <link href="https://artsy.github.io/blog/2018/11/27/switch-from-capybara-webkit-to-chrome/"/>
    <updated>2018-11-27T00:00:00+00:00</updated>
    <id>https://artsy.github.io/blog/2018/11/27/switch-from-capybara-webkit-to-chrome</id>
    <content type="html"><![CDATA[<p>Volt is the internal app name of Artsy CMS, and our partners use it to manage their inventory and presence on artsy.net. It‚Äôs a Rails-based UI app that talks to many API services. We use <a href="https://github.com/rspec/rspec">RSpec</a> extensively to cover controller, model, view, and feature specs. As of Jun. 2018, Volt had 3751 specs and 495 of them were run with JavaScript enabled. It took about 16 mins to run on CircleCI with 6x parallelism.</p>

<p>Capybara-webkit was introduced from the very beginning of Volt for testing JavaScript-enabled specs via headless WebKit browser. It‚Äôs been providing a lot of confidence for the past 4+ years; however, a few reasons/growing concerns have encouraged us to look for (more modern) alternatives:</p>

<!-- more -->

<h2 id="the-problem">The Problem</h2>

<ul>
  <li>The <a href="https://github.com/thoughtbot/capybara-webkit/tree/v1.14.0#qt-dependency-and-installation-issues">dependency of a specific versions of Qt</a> has been causing frustrations to set it up properly both on engineers‚Äô local machines and on CI.</li>
  <li>The roadmap of capybara-webkit development is <a href="https://github.com/thoughtbot/capybara-webkit/issues/885#issuecomment-193988527">unclear</a>.</li>
  <li>It‚Äôs been hard to truly identify the root cause of ‚Äúflickering‚Äù feature specs (i.e. tests that fail intermittently and are hard to reliably reproduce), while retrying tended to resolve it on CI.</li>
  <li>The entire RSpec tests took about 16 mins to complete on CI, with 6 parallelism. The slowness made it unrealistic to run the whole tests locally.</li>
</ul>

<h2 id="the-goal">The Goal</h2>

<p>Headless Chrome has gained a lot of attention in the past few years and migrations done by companies such as <a href="https://about.gitlab.com/2017/12/19/moving-to-headless-chrome/">GitLab</a> and <a href="https://robots.thoughtbot.com/headless-feature-specs-with-chrome">thoughtbot</a> have proven it to be a promising alternative to capybara-webkit. In fact, it‚Äôs been <a href="http://guides.rubyonrails.org/5_1_release_notes.html#system-tests">officially included in Rails 5.1</a> for <a href="https://guides.rubyonrails.org/testing.html#system-testing">system tests</a>.</p>

<p>The goal of this project is to switch to Headless Chrome and maintain the same feature sets we have now. This includes:</p>

<ul>
  <li>Making all existing specs pass</li>
  <li>Running in container environments and using Artsy <a href="https://github.com/artsy/hokusai">Hokusai</a></li>
  <li>Supporting mechanisms to debug specs, e.g. examining browser console logs for JavaScript behavior, taking screenshots on demand and automatically on failure, etc.</li>
  <li>Bonus point to improve the stability of feature specs</li>
  <li>Bonus point to improve the speed of running the entire test suite</li>
</ul>

<h2 id="the-how">The How</h2>

<p>First, we replaced <code class="language-plaintext highlighter-rouge">capybara-webkit</code> with <code class="language-plaintext highlighter-rouge">selenium-webdriver</code> and <code class="language-plaintext highlighter-rouge">chromedriver-helper</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'selenium-webdriver'</span>
<span class="n">gem</span> <span class="s1">'chromedriver-helper'</span>
</code></pre></div></div>

<p><a href="https://github.com/flavorjones/chromedriver-helper"><code class="language-plaintext highlighter-rouge">chromedriver-helper</code></a> was useful to help install <a href="https://sites.google.com/a/chromium.org/chromedriver/">chromedriver</a> in different environments, e.g. an engineer‚Äôs local machine, CI, etc.</p>

<p>Second, we registered both <code class="language-plaintext highlighter-rouge">:chrome</code> and <code class="language-plaintext highlighter-rouge">:headleass_chrome</code> drivers. By default, it used Headless Chrome as the JavaScript driver, and we could easily switch to Chrome and observe the actual interaction happening in a real browser.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Capybara</span><span class="p">.</span><span class="nf">register_driver</span> <span class="ss">:chrome</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="no">Capybara</span><span class="o">::</span><span class="no">Selenium</span><span class="o">::</span><span class="no">Driver</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="ss">browser: :chrome</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Capybara</span><span class="p">.</span><span class="nf">register_driver</span> <span class="ss">:headless_chrome</span> <span class="k">do</span> <span class="o">|</span><span class="n">app</span><span class="o">|</span>
  <span class="n">caps</span> <span class="o">=</span> <span class="no">Selenium</span><span class="o">::</span><span class="no">WebDriver</span><span class="o">::</span><span class="no">Remote</span><span class="o">::</span><span class="no">Capabilities</span><span class="p">.</span><span class="nf">chrome</span><span class="p">(</span><span class="ss">loggingPrefs: </span><span class="p">{</span> <span class="ss">browser: </span><span class="s1">'ALL'</span> <span class="p">})</span>
  <span class="n">opts</span> <span class="o">=</span> <span class="no">Selenium</span><span class="o">::</span><span class="no">WebDriver</span><span class="o">::</span><span class="no">Chrome</span><span class="o">::</span><span class="no">Options</span><span class="p">.</span><span class="nf">new</span>

  <span class="n">chrome_args</span> <span class="o">=</span> <span class="sx">%w[--headless --window-size=1920,1080 --no-sandbox --disable-dev-shm-usage]</span>
  <span class="n">chrome_args</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span> <span class="n">opts</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">}</span>
  <span class="no">Capybara</span><span class="o">::</span><span class="no">Selenium</span><span class="o">::</span><span class="no">Driver</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="ss">browser: :chrome</span><span class="p">,</span> <span class="ss">options: </span><span class="n">opts</span><span class="p">,</span> <span class="ss">desired_capabilities: </span><span class="n">caps</span><span class="p">)</span>
<span class="k">end</span>

<span class="no">Capybara</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># change this to :chrome to observe tests in a real browser</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">javascript_driver</span> <span class="o">=</span> <span class="ss">:headless_chrome</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We were on Rails v5.0.2 and Capybara v2.18.0 during the migration. We will be able to simplify the configuration by using the default <code class="language-plaintext highlighter-rouge">:selenium_chrome</code> and <code class="language-plaintext highlighter-rouge">:selenium_chrome_headless</code> drivers introduced in <a href="https://github.com/teamcapybara/capybara/blob/3.11.1/lib/capybara.rb#L535-L545">Capybara v3.11.1</a>. In addition, Rails v5.1 introduced the new system tests, and it‚Äôll be even simpler by using the <a href="https://api.rubyonrails.org/v5.1.3/classes/ActionDispatch/SystemTestCase.html#method-c-driven_by"><code class="language-plaintext highlighter-rouge">driven_by</code></a> method.</p>

<h2 id="lessons-learned">Lessons Learned</h2>

<p>Naively switching to Headless Chrome caused about 60 spec failures on my local machine. We simply went through them one by one and fixed them. A big part of failures was due to <a href="https://github.com/thoughtbot/capybara-webkit/tree/v1.14.0#non-standard-driver-methods">capybara-webkit‚Äôs non-standard driver methods</a>, such as setting cookies, inspecting console logs, etc., and we just had to migrate to Selenium WebDriver‚Äôs equivalents.</p>

<p>However, we still observed flickering specs on CI, while the exact failures seemed to be different than previously observed with Capybara Webkit. We will have to investigate further for possible causes. Regarding speed, we didn‚Äôt see significant improvement after switching to Headless Chrome, as mentioned in GitLab‚Äôs and others‚Äô blog post, too.</p>

<h2 id="next-steps">Next Steps</h2>

<p>The naive migration to Chrome (and removal of the Qt dependency) already improved the developer experience quite a lot (e.g. no more wrestling with installing Capybara Webkit and Qt 5.5 on every engineer‚Äôs local machine <em>and</em> CI.) There are many next steps we can keep experimenting with and improving our tests, for example</p>

<ul>
  <li>Updating Volt to Rails &gt;= 5.1 and switching to system tests</li>
  <li>Investigating the causes of the flickering specs by looking into intermittent failures reported on CI</li>
  <li>Improving speed by using Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage builds</a>, caching, writing the right type and amount of tests, etc.</li>
</ul>

<p>It‚Äôs a long journey, and we were all excited about the migration and the new future. We‚Äôd love to hear your experience, too!</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How To Debug Jest Tests]]></title>
    <link href="https://artsy.github.io/blog/2018/08/24/How-to-debug-jest-tests/"/>
    <updated>2018-08-24T00:00:00+00:00</updated>
    <id>https://artsy.github.io/blog/2018/08/24/How-to-debug-jest-tests</id>
    <content type="html"><![CDATA[<p>Hey there! My name is Anson and I work on the Platform team at Artsy. Recently, we faced an issue where a certain
<a href="https://github.com/airbnb/enzyme">Enzyme</a> test we wrote using mock tracking was failing, but we couldn‚Äôt figure
out why. Luckily, with some help from <a href="/author/orta">Orta</a> and some clever thinking, we figured out what was going
on.</p>

<!-- more -->

<p>We thought it was an issue with the mock testing library we had written. We tried to fix the problem by sprinkling
<code class="language-plaintext highlighter-rouge">console.log</code> calls throughout the test, but it was still hard to figure out what was going on, especially without
knowing how to peek into the properties of certain objects.</p>

<p>Instead, <a href="/author/orta">Orta</a> suggested we used the Chrome Node DevTools. Since the Enzyme test is run via
<code class="language-plaintext highlighter-rouge">yarn jest</code>, yarn is acting as a frontend for running the Enzyme test with Node. This means that we can use the
Chrome Node DevTools as a debugger to run the Enzyme test. This was super useful since the one thing we needed was
to be able to peek inside certain objects to see what they looked like and how they were failing. It was a much
faster, more methodical way to approach debugging this test. Here are the steps we took:</p>

<ul>
  <li>First, insert a new line in your test where you think it might be failing and type <code class="language-plaintext highlighter-rouge">debugger</code>. This will serve as
a break point for the debugger to stop at.</li>
  <li>Open up Chrome and type in the address bar : <code class="language-plaintext highlighter-rouge">chrome://inspect</code></li>
  <li>Click on ‚ÄúOpen dedicated DevTools for Node‚Äù</li>
  <li>In your terminal, instead of typing <code class="language-plaintext highlighter-rouge">yarn jest &lt;path_to_test&gt;</code>, type this:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node <span class="nt">--inspect</span> node_modules/.bin/jest <span class="nt">--runInBand</span> &lt;path_to_test&gt;
</code></pre></div></div>

<p>Or you can add it to your <code class="language-plaintext highlighter-rouge">package.json</code> as a script:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
    "scripts" : {
<span class="gi">+    "test:debug": "node --inspect node_modules/.bin/jest --runInBand",
</span>    }
  }
</code></pre></div></div>

<p>Which you can then run as <code class="language-plaintext highlighter-rouge">yarn test:debug &lt;path_to_test&gt;</code>.</p>

<p>Voila! Your test should now be running in the Chrome debugger. And you get your handy console to poke around all
sorts of stuff!</p>

<p>You also have the option of using this with Jest‚Äôs <code class="language-plaintext highlighter-rouge">--watch</code> mode in order easily re-run tests, after changes to
app or test code.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node <span class="nt">--inspect</span> node_modules/.bin/jest <span class="nt">--watch</span> <span class="nt">--runInBand</span> &lt;path_to_test&gt;
</code></pre></div></div>

<p>Now simply hit Enter in the terminal running your Jest process anytime you want to re-run your currently selected
specs. You‚Äôll be dropped right back into the Chrome debugger.</p>

<p>You might be wondering how this fixed our tests. Well, turns out that we missed a <code class="language-plaintext highlighter-rouge">jest.unmock()</code> call at the top
of the test file. <em>Facepalm.</em> To prevent this from biting other developers in the future, <a href="/author/orta">Orta</a>
whipped up a <a href="https://github.com/artsy/reaction/pull/1174">pull request</a> to add a rule in our TypeScript linter,
check it out!</p>

<p>Either way, in the future, this will probably be my first step in debugging non-obvious issues in tests, if only to
eliminate possible sources of the issues. I‚Äôm glad I was able to learn with <a href="/author/orta">Orta</a> about a methodical
way to debug test failures. Hope this helps, and happy hacking!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Splitting up a large test suite]]></title>
    <link href="https://artsy.github.io/blog/2015/09/24/splitting-up-a-large-test-suite/"/>
    <updated>2015-09-24T22:13:00+00:00</updated>
    <id>https://artsy.github.io/blog/2015/09/24/splitting-up-a-large-test-suite</id>
    <content type="html"><![CDATA[<p>A while back, we wrote about <a href="/blog/2012/10/09/how-to-run-rspec-test-suites-in-parallel-with-jenkins-ci-build-flow/">How to Run RSpec Test Suites in Parallel with Jenkins CI Build Flow</a>. A version of that still handles our largest test suite, but over time the initial division of specs became unbalanced. We ended up with some tasks that took twice as long as others. Even worse, in an attempt to rebalance task times, we ended up with awkward file patterns like <code class="language-plaintext highlighter-rouge">'spec/api/**/[a-m]*_spec.rb'</code>.</p>

<p>To keep our parallel spec tasks approximately equal in size and to support arbitrary concurrency, we‚Äôve added a new <code class="language-plaintext highlighter-rouge">spec:sliced</code> task:</p>

<!-- more -->

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">namespace</span> <span class="ss">:spec</span> <span class="k">do</span>
  <span class="n">task</span> <span class="ss">:set_up_spec_files</span> <span class="k">do</span>
    <span class="n">spec_files</span> <span class="o">=</span> <span class="no">Dir</span><span class="p">[</span><span class="s1">'spec/**/*_spec.rb'</span><span class="p">]</span>
    <span class="vi">@spec_file_digests</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">[</span><span class="n">spec_files</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="p">[</span><span class="n">f</span><span class="p">,</span> <span class="no">Zlib</span><span class="p">.</span><span class="nf">crc32</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span> <span class="p">}]</span>
  <span class="k">end</span>

  <span class="no">RSpec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:sliced</span><span class="p">,</span> <span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:concurrency</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="ss">:set_up_spec_files</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="p">,</span> <span class="n">args</span><span class="o">|</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="ss">:index</span><span class="p">].</span><span class="nf">to_i</span>
    <span class="n">concurrency</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="ss">:concurrency</span><span class="p">].</span><span class="nf">to_i</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">pattern</span> <span class="o">=</span> <span class="vi">@spec_file_digests</span><span class="p">.</span><span class="nf">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="p">,</span> <span class="n">d</span><span class="o">|</span> <span class="n">d</span> <span class="o">%</span> <span class="n">concurrency</span> <span class="o">==</span> <span class="n">index</span> <span class="p">}.</span><span class="nf">keys</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you can see, the <code class="language-plaintext highlighter-rouge">set_up_spec_files</code> helper task builds a hash of spec file paths and corresponding checksums. When we invoke the <code class="language-plaintext highlighter-rouge">sliced</code> task with <code class="language-plaintext highlighter-rouge">index</code> and <code class="language-plaintext highlighter-rouge">concurrency</code> values (e.g., <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">5</code>), only the spec files with checksums equal to <code class="language-plaintext highlighter-rouge">0</code> when mod-ed by <code class="language-plaintext highlighter-rouge">5</code> are run. Thus, the Jenkins build flow would look like:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parallel</span> <span class="o">(</span>
  <span class="o">{</span><span class="n">build</span><span class="o">(</span><span class="s">"master-ci-task"</span><span class="o">,</span> <span class="nl">tasks:</span> <span class="s">"spec:sliced[0,5]"</span><span class="o">)},</span>
  <span class="o">{</span><span class="n">build</span><span class="o">(</span><span class="s">"master-ci-task"</span><span class="o">,</span> <span class="nl">tasks:</span> <span class="s">"spec:sliced[1,5]"</span><span class="o">)},</span>
  <span class="o">{</span><span class="n">build</span><span class="o">(</span><span class="s">"master-ci-task"</span><span class="o">,</span> <span class="nl">tasks:</span> <span class="s">"spec:sliced[2,5]"</span><span class="o">)},</span>
  <span class="o">{</span><span class="n">build</span><span class="o">(</span><span class="s">"master-ci-task"</span><span class="o">,</span> <span class="nl">tasks:</span> <span class="s">"spec:sliced[3,5]"</span><span class="o">)},</span>
  <span class="o">{</span><span class="n">build</span><span class="o">(</span><span class="s">"master-ci-task"</span><span class="o">,</span> <span class="nl">tasks:</span> <span class="s">"spec:sliced[4,5]"</span><span class="o">)}</span>
<span class="o">)</span>
<span class="n">build</span><span class="o">(</span><span class="s">"master-ci-succeeded"</span><span class="o">)</span>
</code></pre></div></div>

<p>Now, spec times <em>might</em> continue to be unbalanced despite files being split up approximately evenly. (For a more thorough approach based on recording spec times, see <a href="https://github.com/ArturT/knapsack">knapsack</a>.) However, this little bit of randomness was a big improvement over our previous approach, and promises to scale in a uniform manner.</p>
]]></content>
  </entry>
  
</feed>
