<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: debugging | Artsy Engineering]]></title>
  <link href="https://artsy.github.io/blog/categories/debugging/atom.xml" rel="self"/>
  <link href="https://artsy.github.io/"/>
  <updated>2023-07-28T16:13:22+00:00</updated>
  <id>https://artsy.github.io/</id>
  <author>
    <name><![CDATA[]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Are you using the right Mongo geospatial query?]]></title>
    <link href="https://artsy.github.io/blog/2023/02/10/mongo-geospatial-queries/"/>
    <updated>2023-02-10T00:00:00+00:00</updated>
    <id>https://artsy.github.io/blog/2023/02/10/mongo-geospatial-queries</id>
    <content type="html"><![CDATA[<p>We recently got a report from one of our galleries in the Los Angeles area that
they weren‚Äôt showing up on our
<a href="https://www.artsy.net/shows/los-angeles-ca-usa">Los Angeles exhibition listings</a>.</p>

<p>I fielded the report and right away confirmed: when we asked our core API for
<code class="language-plaintext highlighter-rouge">/shows?near=&lt;los angeles coordinates&gt;</code>, sure enough this gallery partner didn‚Äôt
make the cut.</p>

<p>Turns out they are based in Santa Monica, a separate and neighboring
municipality. They must not be within the 25km radius that we use by default for
these sorts of queries.</p>

<p><em>Case closed</em>. Or so I thought.</p>

<!-- more -->

<p>After some back and forth with our partner I decided to investigate more
thoroughly, this time using some tricks of the trade from
<a href="https://www.anandarooproy.com">my other life</a> outside of Artsy.</p>

<h2 id="casting-a-wider-net">Casting a wider net</h2>

<p>If there was something wrong with our 25km radius query, I wanted to start by
casting a wider net and visualizing the results.</p>

<p>I consulted our Rails application code to find the query logic in question, and
then issued the same query directly to MongoDB. Something like the following
query (simplified for clarity):</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a $geoWithin $center query</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
  <span class="na">coordinates</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">$geoWithin</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">$center</span><span class="p">:</span> <span class="p">[[</span><span class="o">-</span><span class="mf">118.24</span><span class="p">,</span> <span class="mf">34.05</span><span class="p">],</span> <span class="mi">25</span> <span class="o">/</span> <span class="mf">111.32</span><span class="p">],</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">})</span>
</code></pre></div></div>

<p>In the query above we are asking MongoDB to give us all events within a 25km
radius around the point 34.05¬∞N, 118.24¬∞W which we have designated as a central
point within Los Angeles. For our purposes in this post we can consider ‚Äúevents‚Äù
‚âà ‚Äúexhibitions‚Äù ‚âà ‚Äúshows.‚Äù</p>

<p>We are not asking for the 25km radius directly, but rather converting it into an
equivalent amount of geographic degrees by using a conversion factor of 1¬∞ ‚âà
111.32 kilometers, a factor which is true at enough the equator.</p>

<p>I modified the above query to cast a 50km net in order to see if there were some
edges cases that needed scrutiny. Taking the resulting JSON response, I fired up
<a href="https://www.placemark.io/">Placemark</a>, my favorite new tool for wrangling
geospatial data.</p>

<p>(Incidentally I recommend reading Tom Macwright‚Äôs
<a href="https://macwright.com/2023/01/28/placemark.html">recent reflection on creating Placemark</a>
as a bootstrapped indie developer.)</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/1.png" alt="Screenshot of a visualization in Placemark showing Los Angeles area exhibitions within a 50km radius." />
  <figcaption>All shows within a 50km radius</figcaption>
</figure>

<h2 id="ball-of-confusion">Ball of confusion</h2>

<p>One nice feature of Placemark is that it lets us place geodesic circles on the
map, that is, circles that represent a constant radius around a point, as
plotted on a globe.</p>

<p>When I placed a 25km radius circle on the map, something stood out immediately.</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/2.png" alt="Screenshot of a visualization in Placemark showing Los Angeles area exhibitions within a 50km radius, with a 25km radius superimposed." />
  <figcaption>25km radius superimposed. <a style="padding-bottom: 1px; border-bottom: solid 1px lightgray" href="https://en.wikipedia.org/wiki/Ball_of_Confusion_%28That%27s_What_the_World_Is_Today%29">Ball of Confusion</a>, that's what the world was that day.</figcaption>
</figure>

<p>The partner in question is highlighted in pink‚ÄØ‚Äî‚ÄØand is clearly within the 25km
radius. <strong>What gives?</strong></p>

<p>By spot-checking a few points on the map against our current geo query I found
that edge cases near the top or bottom of the circle were likely to be evaluated
correctly, while edges cases at the left and right were being incorrectly
omitted, as our partner gallery was.</p>

<p>A fuller visualization of that finding would look like this:</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/3.png" alt="Screenshot of a visualization in Placemark showing the results of a $geoWithin $center query" />
  <figcaption>Results of a <code>$geoWithin $center</code> query around Los Angeles, evaluated against a grid of test points.</figcaption>
</figure>

<p>A distinctly <em>non</em>-circular circle‚ÄØ‚Äî‚ÄØthat rung a bell.</p>

<h2 id="more-than-one-way-to-draw-a-circle-on-the-earth">More than one way to draw a circle on the Earth</h2>

<p>It was at this point that I recalled the specific form of the geospatial query
our code was performing, and consulted the
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/geoWithin/">MongoDB docs for the $geoWithin query</a>.</p>

<p>Turns out that you can invoke this as a radius query in one of two ways, by
specifying
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/center/">$center</a>
or
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/centerSphere/">$centerSphere</a>.</p>

<p>Per the
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/center/#behavior">docs</a>
for <code class="language-plaintext highlighter-rouge">$center</code>, this query‚Ä¶</p>

<blockquote>
  <p>calculates distances using flat (planar) geometry</p>
</blockquote>

<p>Let us pause for a moment to note that while only some maps are
<a href="https://press.uchicago.edu/ucp/books/book/chicago/H/bo27400568.html">deceitful</a>,
<em>all</em> maps are untruths. In the sense that they flatten three dimensions down to
two, and inevitably distort the world in the process.</p>

<p>The surface of a three-dimensional globe cannot be flattened down to a
two-dimensional plane without some stretching or tearing, any more than an
orange peel can be. The mathematical algorithms for turning those three
dimensions into two are what we know as map projections. (Ah, the good old days
when ‚Äúdimensionality reduction‚Äù meant <em>from three to two</em>.)</p>

<p>If you do your distance calculations in such a flattened, projected coordinate
system‚ÄØ‚Äî‚ÄØas the <code class="language-plaintext highlighter-rouge">$geoWithin $center</code> query does‚ÄØ‚Äî‚ÄØthen you are accepting
whatever distortions are inherent to that projection.</p>

<p>That‚Äôs the situation we were in. We thought we were catching everything inside
the green circle, but in fact we were only catching everything inside the red
egg:</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/5.png" alt="Screenshot of a visualization in Placemark showing the results of a $geoWithin $center query compared to the expected results" />
  <figcaption>Actual <code>$geoWithin $center</code> results vs. expected results.</figcaption>
</figure>

<p>And our unfortunate partner was <em>just</em> outside the egg, thus being incorrectly
omitted.</p>

<h2 id="fixing-the-query">Fixing the query</h2>

<p>Luckily the solution was simple.</p>

<p>As noted above MongoDB supports a second variant for radius queries using a
<code class="language-plaintext highlighter-rouge">$centerSphere</code> operator instead of the <code class="language-plaintext highlighter-rouge">$center</code> that we were using.</p>

<p>Per the
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/centerSphere/">docs</a>
for <code class="language-plaintext highlighter-rouge">$centerSphere</code>, this version‚Ä¶</p>

<blockquote>
  <p>defines a circle for a geospatial query that uses spherical geometry</p>
</blockquote>

<p>In other words, this query effectively draws our circle on the three-dimensional
globe rather than on the stretched and distorted two-dimensional map.</p>

<p>We just need to rewrite our query as follows:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a $geoWithin $centerSphere query</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
  <span class="na">coordinates</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">$geoWithin</span><span class="p">:</span> <span class="p">{</span>
      <span class="c1">// $center: [[-118.24, 34.05], 25 / 111.32],    /* BEFORE */</span>
      <span class="na">$centerSphere</span><span class="p">:</span> <span class="p">[[</span><span class="o">-</span><span class="mf">118.24</span><span class="p">,</span> <span class="mf">34.05</span><span class="p">],</span> <span class="mi">25</span> <span class="o">/</span> <span class="mf">6378.1</span><span class="p">]</span> <span class="cm">/* AFTER */</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">},</span>
<span class="p">})</span>
</code></pre></div></div>

<p>There is a new conversion factor in play here, this time denoting that the
radius of the earth is approximately 6378.1 km. In this <code class="language-plaintext highlighter-rouge">$centerSphere</code> flavor
of the query we are working in unprojected
<a href="https://en.wikipedia.org/wiki/Spherical_coordinate_system">spherical coordinates</a>,
measured in <a href="https://en.wikipedia.org/wiki/Radian">radians</a>. Thus we need to
account for the size of the sphere that we are calculating upon.</p>

<p>We can re-run
<a href="https://gist.github.com/anandaroop/a1b794559615b2bbdea097678321c93f">our test</a>
with this version of the query, and now we see that the results are finally in
line with what we were expecting:</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/4.png" alt="Screenshot of a visualization in Placemark showing the results of a $geoWithin $centerSphere query" />
  <figcaption>Results of a <code>$geoWithin $centerSphere</code> query around Los Angeles, evaluated against a grid of test points.</figcaption>
</figure>

<p>Having updated our API to use this variant of the query, we solved the problem
and returned our partner gallery to its rightful place in our listings, as shown
by the pink highlight above.</p>

<p>That was the happy ending we were looking for.</p>

<h2 id="a-postscript-on-map-distortion">A postscript on map distortion</h2>

<p>But if you‚Äôre curious to learn a little more about map distortion, let‚Äôs dig a
bit deeper into the nature of the problem that we were encountering.</p>

<p>Returning to <a href="https://www.placemark.io/">Placemark</a>‚Äôs ability to draw different
kinds of circles on the map, let‚Äôs now place a <em>geographic</em> circle on the map
rather than a geodesic one. This one is computed in the simplest possible map
projection‚ÄØ‚Äî‚ÄØa geographic projection where we simply treat the longitude as the
X coordinate and the latitude as the Y coordinate. (This projection goes by many
names, such as ‚Äúgeographic‚Äù, ‚Äúequirectangular‚Äù, ‚ÄúPlate Carr√©e‚Äù or even
<em>‚Äúunprojected‚Äù</em>, which is not quite accurate.)</p>

<p>This corresponds to what you get when you use MongoDB‚Äôs <code class="language-plaintext highlighter-rouge">$geoWithin</code> <code class="language-plaintext highlighter-rouge">$center</code>
query on geospatial data:</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/6.gif" alt="Animation showing the distortion a geographic circle encounters at various latitudes" />
  <figcaption>Animation showing the distortion a geographic circle encounters at various latitudes.</figcaption>
</figure>

<p>As you can see, we get: a moderately oblong egg at the latitude of Los Angeles;
a nice circle as we get close to the equator; and a very oblong egg as we
approach the poles.</p>

<p>If you are wondering why you should trust my claims about the egginess of <em>this</em>
two-dimensional image after I just said that all such maps are lies‚ÄØ‚Äî‚ÄØgood
question!</p>

<p>It just so happens that nearly all web-based interactive maps, including
Placemark, use a variation of the Mercator projection, the one you might
remember from schoolroom maps. Mercator is a so-called
‚Äú<a href="https://en.wikipedia.org/wiki/Conformal_map_projection">conformal</a>‚Äù
projection, meaning that <em>its</em> particular lie is to sacrifice area in favor of
shape.</p>

<p>A shape drawn on a globe will be correctly maintained in a Mercator map, but the
scale will vary across the map: true at the equator and very incorrect towards
the poles. This is the reason for the common complaint that
<a href="https://www.nature.com/nature-index/news-blog/data-visualisation-animated-map-mercater-projection-true-size-countries">Mercator maps show Greenland as about the same size as Africa</a>,
when in fact Africa is about 14 times larger.</p>

<p>The amount and nature of the distortion introduced by map projections is such an
important topic that cartographers have long relied on a clever technique for
communicating this distortion visually, known as
‚Äú<a href="https://en.wikipedia.org/wiki/Tissot%27s_indicatrix">Tissot‚Äôs indicatrix</a>.‚Äù</p>

<p>To give you a sense of the kind of distortion we encountered with the <code class="language-plaintext highlighter-rouge">$center</code>
query, here is what Tissot‚Äôs indicatrix looks like for the geographic
projection. This shows essentially the inverse of the animation above‚ÄØ‚Äî‚ÄØwhat
does a true circle plotted on the globe look like at various locations on this
map projection?</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/7.png" alt="Tissot's indicatrix for equirectangular projection" />
  <figcaption>Tissot's indicatrix for equirectangular projection. Credit: Justin Kunimune, <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>, via Wikimedia Commons</figcaption>
</figure>

<p>Now, imagine the inverse operation of this ‚§¥Ô∏é, drawing <em>true</em> circles on this
planar space, in order to get a sense of how distorted your query results on a
globe would be.</p>

<p>Finally, here is Tissot‚Äôs indicatrix for the Mercator projection, demonstrating
its ability to preserve shapes at the expense of sizes.</p>

<figure class="illustration">
  <img src="/images/2023-02-10-mongo-geospatial-queries/8.png" alt="Tissot's indicatrix for Mercator projection" />
  <figcaption>Tissot's indicatrix for Mercator projection. Credit: Eric Gaba, <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>, via Wikimedia Commons</figcaption>
</figure>

<p>An interesting recent development is that the web‚Äôs reliance on Mercator is
changing, but only very slowly.
<a href="https://www.theverge.com/2018/8/5/17653122/google-maps-update-mercator-projection-earth-isnt-flat">Google began to make this change</a>
a few years ago, and
<a href="https://www.mapbox.com/blog/adaptive-projections">Mapbox has written about their approach</a>
as well.</p>

<p>Hopefully this digression into the display of geospatial data has been
illuminating. There is much more to say on this topic, since geospatial is more
or less one asterisk after another. For example, we haven‚Äôt mentioned that the
Mercator projection above is incapable of depicting the north or south poles at
all! Nor have we touched on MongoDB‚Äôs various geospatial
<a href="https://www.mongodb.com/docs/manual/geospatial-queries/#geospatial-data">data formats</a>,
<a href="https://www.mongodb.com/docs/manual/geospatial-queries/#geospatial-indexes">indexes</a>,
or
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/near/">the $near query</a>
and its spherical sibling
<a href="https://www.mongodb.com/docs/manual/reference/operator/query/nearSphere/">the $nearSphere query</a>,
all worthy topics.</p>

<p>But we hope that understanding this crucial distinction between planar
(<code class="language-plaintext highlighter-rouge">$center</code>) and spherical (<code class="language-plaintext highlighter-rouge">$centerSphere</code>) calculations will help you make the
right choice when devising your own radius queries with MongoDB or other
geospatial engines.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using OCR To Fix a Hilarious Bug]]></title>
    <link href="https://artsy.github.io/blog/2015/11/05/Using-OCR-To-Fix-A-Hilarious-Bug/"/>
    <updated>2015-11-05T00:00:00+00:00</updated>
    <id>https://artsy.github.io/blog/2015/11/05/Using-OCR-To-Fix-A-Hilarious-Bug</id>
    <content type="html"><![CDATA[<p>For a little while, we would get very strange bug reports. People would complain that artist thumbnails (viewed in several different contexts across the web and our iOS apps) would not be an image of the artist‚Äôs work, but rather text, which had inexplicably become an actual JPG. This wasn‚Äôt just text appearing in a <code class="language-plaintext highlighter-rouge">div</code> that should contain an <code class="language-plaintext highlighter-rouge">img</code> or something like that, these were actual JPG‚Äôs that were pictures of text.</p>

<p>We would fix these as they came up, chalking the strangeness up to some relic of an old image processing pipeline, data being migrated, etc.</p>

<p>However, the reports kept coming in. This blog post is about how we diagnosed this actual bug, and how we used a simple Ruby script and OCR to help us detect and fix the existing images.</p>

<!-- more -->

<p>Here‚Äôs an example of a bug report where the thumbnail for <a href="https://www.artsy.net/artist/marina-abramovic-1">Marina Abramoviƒá</a> became the text of her bio.</p>

<p><img src="/images/2015-11-12-hilarious-bug/search.png" alt="Bad Search" /></p>

<p>Here‚Äôs one from our <a href="https://github.com/artsy/eigen">iOS app</a> showing that thumbnails for related artists are set to their bios as well.</p>

<p><img src="/images/2015-11-12-hilarious-bug/eigen.png" alt="Bad Related Artists" /></p>

<p>Weird right? We eventually tracked down what was going on, and it‚Äôs actually perfectly summarized in <a href="https://github.com/blueimp/jQuery-File-Upload/pull/3356">this issue</a>. When someone copies text from Excel, it also generates an image of that cell or cells, and puts it into the clipboard. We immediately suspected something with <code class="language-plaintext highlighter-rouge">pasteZone</code>, and the bug was easy to reproduce - have an image in your clipboard and paste anywhere on the page.</p>

<p>We have an admin panel that allows some metadata about an artist to be edited. This includes their bio, as well as a place to upload a representative image as their ‚Äòcover thumbnail‚Äô.</p>

<p>As the issue describes, we had some text input fields, as well as a file upload form using <a href="https://github.com/blueimp/jQuery-File-Upload">Blueimp‚Äôs jQuery File Upload</a>. When you don‚Äôt specify a <code class="language-plaintext highlighter-rouge">pasteZone</code> it defaults to the entire document. This means that a paste event anywhere on the page will trigger that event.</p>

<p>Our editorial team was using Microsoft Excel and Word to organize some data about the artist, including bios. When ready, a team member would copy and paste the bio into the bio input text field. This would also immediately fire the event for the image upload, which now automagically became an actual picture of the text of the bio. Our API and image processing pipeline would happily accept that, leading to the incredibly bizarre bug reports.</p>

<p>My immediate fix was to specify and scope <code class="language-plaintext highlighter-rouge">pasteZone</code> (and similarly, <code class="language-plaintext highlighter-rouge">dropZone</code>) to the element the file upload widget was bound to. That would prevent the problem from happening again. Taking a quick look art some random samples of artists, it looked like potentially thousands of records might have been affected and I became interested in a programmatic way to detect these images. A manual approach would have been very cumbersome.</p>

<p>Since the images were that of text, I decided to use OCR to remove artist thumbnails that it determined had ‚Äòtoo much text‚Äô. This may have unset valid covers from artists that use lots of text in their work, such as <a href="https://www.artsy.net/artist/joseph-kosuth">Joseph Kosuth</a>. However, this was safe to do since we have some custom logic to fall back to an image of an iconic artwork by the artist in the case of a missing thumbnail.</p>

<p>To get OCR functionality in Ruby, I decided to use <a href="https://github.com/tesseract-ocr/tesseract">Tesseract</a>, a great OSS library. Once I had it installed, I used a <a href="https://github.com/meh/ruby-tesseract-ocr">ruby wrapper</a> to make using it easier.</p>

<p>The script eventually turned into something like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># initialize and configure Tesseract</span>
<span class="n">engine</span> <span class="o">=</span> <span class="no">Tesseract</span><span class="o">::</span><span class="no">Engine</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">language</span>  <span class="o">=</span> <span class="ss">:eng</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">blacklist</span> <span class="o">=</span> <span class="s1">'|'</span>
<span class="k">end</span>

<span class="c1"># iterate over artists and pull their thumbnails</span>
<span class="c1"># given the URL to a publicly accessible image at img</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">text_for</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/[^a-z ]/i</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nf">gsub</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
<span class="k">if</span> <span class="n">text</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">30</span>
  <span class="nb">puts</span> <span class="s2">"Found problematic artist </span><span class="si">#{</span><span class="n">artist_doc</span><span class="p">[</span><span class="s1">'last'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>So all we do is find all the text in an image, and then remove any garbage characters or artifacts from the OCR analysis, and then use 30 as an arbitrary cutoff to determine if an image was problematic. If the image had more than 30 characters as detected by the OCR library, we wound up unsetting it from the artist.</p>

<p>The additional logic to set artist covers from their iconic artworks was already in place, and I ran this script in production, identifying and unsetting over 1000 problematic thumbnails. And we haven‚Äôt gotten any new reports of this bug since then :)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Notorious BUG ‚Äì The Unbugged Sessions Part 1]]></title>
    <link href="https://artsy.github.io/blog/2015/07/30/Notorious-BUG-Part-1/"/>
    <updated>2015-07-30T19:21:00+00:00</updated>
    <id>https://artsy.github.io/blog/2015/07/30/Notorious-BUG-Part-1</id>
    <content type="html"><![CDATA[<p>When the odds are stacked against you, your mind is overflowing, and you are ready to just pop, there‚Äôs always practical
debugging tips to help you through a cloudy day.</p>

<p>In this post I‚Äôll take you through a debugging session where I reproduce a crash, for which we were receiving a bunch of
crash reports, but I was unable to reproduce by just using the application.</p>

<p>It will cover the following topics:</p>

<ul>
  <li>Narrow down the breakpoint to the method invocation where the crash occurs.</li>
  <li>Locate the exact instruction that causes the crash.</li>
  <li>Look at the implementation of the method where the crash occurs.</li>
  <li>Simulate the crash.</li>
</ul>

<!-- more -->

<h3 id="the-crash-report">The crash report</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hardware Model:  iPhone5,2
OS Version:      iPhone OS 8.1.2 (12B440)

Exception Type:  SIGSEGV
Exception Codes: SEGV_ACCERR at 0x10
Crashed Thread:  0

Thread 0 Crashed:
0   libobjc.A.dylib                      0x33034f46 objc_msgSend + 5
1   UIKit                                0x28d7e4bd -[UIScrollView _getDelegateZoomView] + 66
2   UIKit                                0x2599b757 -[UIScrollView _offsetForCenterOfPossibleZoomView:withIncomingBoundsSize:] + 42
[SNIP]
7   Artsy                                0x00107087 -[ARArtworkView setUpCallbacks] + 1238
[SNIP]
</code></pre></div></div>

<p><em>This crash report was shortened for clarity sake, you can find the full report
<a href="https://gist.github.com/alloy/cfaab5b754fdd2c551e0">here</a>.</em></p>

<p>Now, this might not be the toughest nut to crack ‚Äìif you‚Äôve been doing UIKit development for a while, you may already
know that <code class="language-plaintext highlighter-rouge">UIScrollView</code> does not weakify it‚Äôs <code class="language-plaintext highlighter-rouge">delegate</code>‚Äì but instead of just going by experience and making some
changes, let‚Äôs see if we can‚Äôt figure out exactly what‚Äôs happening, for the sake of reproducing and confidently making
the right fix.</p>

<p>The lines near the top of the stack trace tell me that it‚Äôs probably a message being sent to some garbage memory, i.e.
a released object, so that‚Äôs where I want to be poking around.</p>

<h3 id="getting-at-often-called-locations">Getting at often called locations</h3>

<p>So I want to get at the 2nd frame in the stack, but that method and the one at the 3rd frame get invoked <em>a lot</em> while
navigating to the view I want to debug. There‚Äôs many ways to do this, but the simple approach I often take in these
cases is to set a breakpoint for the last frame in the stack that is <em>unique to the location that I want to get at</em> and
then keep refining the breakpoints every time I hit one.</p>

<p>In this case that starts off with a breakpoint in
<a href="https://github.com/artsy/eigen/blob/1.7.0/Artsy/Classes/Views/ARArtworkView.m#L85">our code</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(lldb) b -[ARArtworkView setUpCallbacks]
Breakpoint 1: where = Artsy`-[ARArtworkView setUpCallbacks] + 19 at ARArtworkView.m:101, address = 0x000000010e722853
</code></pre></div></div>

<p>With that set I then navigate to the view I want to get at and, once the breakpoint is hit, set the breakpoint for a
frame that‚Äôs even closer to the location I want to get at:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Process 74926 stopped
* thread #1: tid = 0x1b5faf, 0x000000010e722853 Artsy`-[ARArtworkView setUpCallbacks](self=0x00007fc99c95b230, _cmd=0x000000010eb60e58) + 19 at ARArtworkView.m:101, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1
    frame #0: 0x000000010e722853 Artsy`-[ARArtworkView setUpCallbacks](self=0x00007fc99c95b230, _cmd=0x000000010eb60e58) + 19 at ARArtworkView.m:101

(lldb) b -[UIScrollView _offsetForCenterOfPossibleZoomView:withIncomingBoundsSize:]
Breakpoint 2: where = UIKit`-[UIScrollView _offsetForCenterOfPossibleZoomView:withIncomingBoundsSize:], address = 0x00000001105c1fb7
</code></pre></div></div>

<p>And finally I repeat the process and set the breakpoint that I <em>really</em> want to get to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(lldb) b -[UIScrollView _getDelegateZoomView]
Breakpoint 3: where = UIKit`-[UIScrollView _getDelegateZoomView], address = 0x00000001105bf8cd
</code></pre></div></div>

<h3 id="locating-the-instruction-that-crashes-by-looking-at-the-real-on-device-framework-iphoneos-sdk">Locating the instruction that crashes by looking at the real <em>on-device</em> framework (iPhoneOS SDK)</h3>

<p>By this point, I‚Äôm left with the realization that I don‚Äôt have a device running iOS 8.1.x anymore ‚Äìthe above was all on
the simulator‚Äì and thus jumping through the code in a debugger on a device is not going to be reliable. Instead, I‚Äôm
going to take a look at the disassembly and (pseudo) decompiled code in <a href="http://www.hopperapp.com">Hopper</a> ‚Äìa tool I
highly suggest you go and buy <strong>right now</strong>, it‚Äôs ridiculously cheap for the amount of time it will save you‚Äì.</p>

<p>To be able to do so, though, I first had to get a copy of UIKit for one of the devices of which we received crash logs.</p>

<ul>
  <li>
    <p><strong>Firmware decryption keys</strong>: keys for many variants are listed
<a href="https://www.theiphonewiki.com/wiki/Firmware_Keys">here</a>. If the model you need is not listed you‚Äôll have to manually
figure out the key, which is beyond the scope of this article.</p>
  </li>
  <li>
    <p><strong>Download firmware</strong>: you can find links for all variants on
<a href="https://www.theiphonewiki.com/wiki/Firmware">this page</a>. I chose iOS 8.1.2 for the 2nd revision of the iPhone 5
(iPhone 5,2), because the keys to decrypt that are known and it‚Äôs one of the devices and OS versions for which we had
received crash reports.</p>
  </li>
  <li>
    <p><strong>Decrypt image</strong>: there are a bunch of tools that allow you to decrypt firmware images, which are listed
<a href="https://www.theiphonewiki.com/wiki/Category:Decryption">here</a>. I‚Äôm using
<a href="https://www.theiphonewiki.com/wiki/Dmg_(command)">xpwn‚Äôs ‚Äòdmg‚Äô tool</a> which you can get from
<a href="https://github.com/planetbeing/xpwn/tree/master/dmg">planetbeing‚Äôs GitHub repo</a>. Once you‚Äôve got the key from
<a href="https://www.theiphonewiki.com/wiki/Firmware_Keys">here</a>, or have otherwise manually figured it out, you can decrypt
the disk image like so:</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ unzip -d iPhone5,2_8.1.2 iPhone5,2_8.1.2_12B440_Restore.ipsw
$ cd iPhone5,2_8.1.2
$ /path/to/xpwn/dmg/dmg extract 058-09875-017.dmg decrypted.dmg -k 02e89744a7143b9bac48fd1adc32a8ed6bcf74d428d0861d790153accb96a413e1c3b8d8
</code></pre></div></div>

<ul>
  <li><strong>Extract UIKit from shared DYLD cache</strong>: for performance reasons, Apple decided to create one big cache that
contains all of the commonly used frameworks, including UIKit. To get just UIKit, you‚Äôll need to use any of the tools
listed <a href="http://iphonedevwiki.net/index.php/Dyld_shared_cache#Cache_extraction">here</a>, I used
<a href="https://github.com/kennytm/Miscellaneous/downloads">dyld_decache</a>:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ open decrypted.dmg
$ /path/to/dyld_decache-v0.1c -o Extracted -f UIKit /Volumes/SUOkemoTaos12B440.N42OS/System/Library/Caches/com.apple.dyld/dyld_shared_cache_armv7s
$ ls -l Extracted/System/Library/Frameworks/UIKit.framework/UIKit
-rw-r--r--  1 eloy  staff  12142776 Aug  1 10:50 Extracted/System/Library/Frameworks/UIKit.framework/UIKit
</code></pre></div></div>

<p>With that out of the way, I can finally load that up in Hopper and look at the instruction. I can get the offset of
the instruction from the stack frame, specifically the ‚Äò66‚Äô in
<code class="language-plaintext highlighter-rouge">-[UIScrollView _getDelegateZoomView] + 66</code>. This means that the instruction‚Äôs address is that of the function it is
located in <em>plus</em> 66, which, as you can see in the below screenshot, is halfway through the <code class="language-plaintext highlighter-rouge">objc_msgSend</code> call:</p>

<p><a href="/images/2015-07-30-Notorious-BUG-1/Hopper-Disassembled.png">
  <img src="/images/2015-07-30-Notorious-BUG-1/Hopper-Disassembled.png" alt="The assembly of the `-[UIScrollView _getDelegateZoomView]` method." style="" />
</a></p>

<p>If you want to get into the details of what these instructions are doing, I suggest you read up on a blog post such as
<a href="https://www.mikeash.com/pyblog/friday-qa-2011-12-30-disassembling-the-assembly-part-3-arm-edition.html">this article by Mike Ash</a>.
The important part here is that you can easily see that it‚Äôs all related to sending the following message to the scroll
view‚Äôs delegate:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[delegate respondsToSelector:@selector(viewForZoomingInScrollView:)]
</code></pre></div></div>

<p>Hopper can give us (pseudo) decompiled code for this method, which looks like the following:</p>

<p><a href="/images/2015-07-30-Notorious-BUG-1/Hopper-Decompiled.png">
  <img src="/images/2015-07-30-Notorious-BUG-1/Hopper-Decompiled.png" alt="The pseudo-code of the `-[UIScrollView _getDelegateZoomView]` method." style="" />
</a></p>

<p>Based on that, it‚Äôs clear to see that that‚Äôs what happens and so it‚Äôs the delegate that points to garbage, <code class="language-plaintext highlighter-rouge">0x10</code> in
this crash report to be specific.</p>

<h3 id="simulating-the-crash">Simulating the crash</h3>

<p>Now that I know what‚Äôs happening, it‚Äôs time to simulate the crash on the Simulator so that I can confidently make the
fix for what I think is going wrong.</p>

<p>Based on the above, I now know that, on the Simulator, this crash would occur around the 16th instruction, which is
where the <code class="language-plaintext highlighter-rouge">-respondsToSelector:</code> message gets sent, so I‚Äôll jump to just before it, but <em>after</em> where the <code class="language-plaintext highlighter-rouge">delegate</code>
variable would get set:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(lldb) disassemble --frame
UIKit`-[UIScrollView _getDelegateZoomView]:
-&gt; 0x1105bf8cd:  pushq  %rbp
   0x1105bf8ce:  movq   %rsp, %rbp
   0x1105bf8d1:  pushq  %r15
   0x1105bf8d3:  pushq  %r14
   0x1105bf8d5:  pushq  %rbx
   0x1105bf8d6:  pushq  %rax
   0x1105bf8d7:  movq   %rdi, %r14
   0x1105bf8da:  movq   0xd344ef(%rip), %rax      ; UIScrollView._zoomView
   0x1105bf8e1:  movq   (%r14,%rax), %rbx
   0x1105bf8e5:  testq  %rbx, %rbx
   0x1105bf8e8:  jne    0x1105bf97b               ; -[UIScrollView _getDelegateZoomView] + 174
   0x1105bf8ee:  movq   0xd344c3(%rip), %r15      ; UIScrollView._delegate
   0x1105bf8f5:  movq   (%r14,%r15), %rdi
   0x1105bf8f9:  movq   0xd08228(%rip), %rdx      ; "viewForZoomingInScrollView:"
   0x1105bf900:  movq   0xd02df9(%rip), %rsi      ; "respondsToSelector:"
   0x1105bf907:  callq  *0xac2783(%rip)           ; (void *)0x0000000111fe1000: objc_msgSend
[SNIP]

(lldb) step --count 13
Process 74926 stopped
* thread #1: tid = 0x1b5faf, 0x00000001105bf8f9 UIKit`-[UIScrollView _getDelegateZoomView] + 44, queue = 'com.apple.main-thread', stop reason = instruction step into
    frame #0: 0x00000001105bf8f9 UIKit`-[UIScrollView _getDelegateZoomView] + 44
UIKit`-[UIScrollView _getDelegateZoomView] + 44:
   0x1105bf8f5:  movq   (%r14,%r15), %rdi
-&gt; 0x1105bf8f9:  movq   0xd08228(%rip), %rdx      ; "viewForZoomingInScrollView:"
   0x1105bf900:  movq   0xd02df9(%rip), %rsi      ; "respondsToSelector:"
   0x1105bf907:  callq  *0xac2783(%rip)           ; (void *)0x0000000111fe1000: objc_msgSend
   0x1105bf90d:  xorl   %ebx, %ebx
</code></pre></div></div>

<p>At this instruction, the object to which the message will be sent has been assigned to the <code class="language-plaintext highlighter-rouge">$rdi</code> register, which in my
case is still the expected and valid object:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(lldb) po $rdi
&lt;ARArtworkViewController: 0x7fc99c9681d0&gt;
</code></pre></div></div>

<p>At this point I can just override the register with the garbage shown in the crash report:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(lldb) register write rdi 0x10
</code></pre></div></div>

<p>And finally continue execution and let the crashing occur:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(lldb) bt
* thread #1: tid = 0x1b5faf, 0x0000000111fe1005 libobjc.A.dylib`objc_msgSend + 5, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x10)
  * frame #0: 0x0000000111fe1005 libobjc.A.dylib`objc_msgSend + 5
    frame #1: 0x00000001105bf90d UIKit`-[UIScrollView _getDelegateZoomView] + 64
    frame #2: 0x00000001105c1fe9 UIKit`-[UIScrollView _offsetForCenterOfPossibleZoomView:withIncomingBoundsSize:] + 50
[SNIP]
    frame #7: 0x000000010e722853 Artsy`-[ARArtworkView setUpCallbacks] + 19
[SNIP]
</code></pre></div></div>

<p>üí•</p>

<p>Perfect, an exact replica of the crash report, so now I know with confidence that the problem is that the
<code class="language-plaintext highlighter-rouge">ARArtworkViewController</code> is released by the time that method is called.</p>

<h3 id="closing-thoughts">Closing thoughts</h3>

<p>The fix for this crash is simple and not really interesting for this post, as it‚Äôs all about the steps I took to arrive
there. I think these are way more interesting, as you can apply some/all of these in many different situations.</p>

<p>But for completeness sake, the fix is to make sure that <a href="https://github.com/artsy/eigen/blob/356b88d1ff035a9f0aa28f19e42255c7152a88f4/Artsy/View_Controllers/Artwork/ARArtworkViewController.m#L28">the scroll view‚Äôs delegate gets nillified</a>
before the view controller is released and <em>in addition</em> it lead to me figuring out why the scroll view was still even
alive at that time, which was <a href="https://github.com/artsy/eigen/commit/8db7b1e75563ee2ee7b547223cb02e1e646e7bd8">a block retention-cycle</a>.</p>
]]></content>
  </entry>
  
</feed>
