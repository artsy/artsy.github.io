
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Artsy Engineering</title>
  <meta name="author" content="Artsy">

  
  <meta name="description" content="An infinite scroll can be a beautiful and functional way to present feed data. You can see ours on the homepage of artsy.net. It works by fetching a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://artsy.github.io/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Artsy Engineering" type="application/atom+xml">
  <!--[if IE 8]>
<link href="/stylesheets/custom/ie_font.css" type="text/css">
<![endif]-->
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12450662-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>


<body>
  
  <a href="/">
    <h1 id="lrg-mark">
      <span>Artsy</span>
    </h1>
  </a>
  
  <header id="banner"><hgroup>
  <div id="header">
    <h2>Inspiration from the engineering team at <a href="http://artsy.net">Artsy</a> â€” A new way to discover fine art.</h2>
  </div>
</hgroup>

</header>
  
  <div id="main">
    <div id="mobile_search">
      <form action="http://google.com/search" method="get">
        <input type="hidden" name="q" value="site:artsy.github.io" />
        <input class="search" type="text" name="q" results="0" placeholder="Search" />
      </form>
    </div>
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
    <a href="/blog/2013/02/15/infinite-scroll-with-mongodb/">
      <div class="date">




  
<time datetime="2013-02-15T21:21:00-05:00" pubdate>02/15/13</time></div>
    
    
      <h1 class="entry-title">Infinite Scroll With MongoDB</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>An infinite scroll can be a beautiful and functional way to present feed data. You can see ours on the <a href="http://artsy.net/">homepage of artsy.net</a>. It works by fetching a few items from the API, then fetching some more items as the user scrolls down the feed. Each API call returns the items along with a &#8220;cursor&#8221;, which marks the position of the last item retrieved. Subsequent API calls include the cursor in the query string and the iteration resumes from there.</p>

<p>Why use a cursor and not standard pagination? Because inserting an item on top of the feed would shift the existing items down, causing the API to return a duplicate item on the page boundary. Removing an item from the top of the feed would pull the remaining items up, causing an item to be missed in the next request on the page boundary.</p>

<p>Today we&#8217;re open-sourcing a small gem called <a href="https://github.com/dblock/mongoid-scroll">mongoid-scroll</a>, which implements this cursor-like behavior for MongoDB using mongoid or moped. Here&#8217;s how it works.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/02/15/infinite-scroll-with-mongodb/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2013/02/09/data-corruption-and-concurrent-updates-to-embedded-objects-with-mongoid/">
      <div class="date">




  
<time datetime="2013-02-09T21:21:00-05:00" pubdate>02/09/13</time></div>
    
    
      <h1 class="entry-title">Data Corruption and Concurrent Updates to Embedded Objects With MongoDB</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>We use <a href="http://www.mongodb.org/">MongoDB</a> at Artsy as our primary data store via the <a href="http://mongoid.org/">Mongoid ODM</a>. Eventually, we started noticing data corruption inside embedded objects at an alarming rate of 2-3 records a day. The number of occurrences increased rapidly with load as our user growth accelerated.</p>

<p>The root cause was not a HN-worthy sensational declaration about how MongoDB trashes data, but our lack of understanding of what can and cannot be concurrently written to the database, neatly hidden behind the object data mapping layer.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/02/09/data-corruption-and-concurrent-updates-to-embedded-objects-with-mongoid/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2013/02/01/master-heroku-command-line-with-heroku-commander/">
      <div class="date">




  
<time datetime="2013-02-01T21:21:00-05:00" pubdate>02/01/13</time></div>
    
    
      <h1 class="entry-title">Master the Heroku CLI With Heroku Commander</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/2013-02-01-master-heroku-command-line-with-heroku-commander/heroku-commander.png"></p>

<p>Heroku users frequently run the <strong>heroku</strong> command-line tool that ships with the <a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a>. It has two very convenient features: it will remember API credentials and default to the &#8220;heroku&#8221; GIT remote to figure out the application to connect to. Neither of these features are available in the Heroku client API, so it&#8217;s not unusual to find developers invoke the Heroku CLI from Rake tasks and other automation scripts.</p>

<p>There&#8217;re several problems with using the Heroku CLI for automation:</p>

<ol>
<li>The exit code from <code>heroku run</code> is not the exit code from the process being run on Heroku. See <a href="https://github.com/heroku/heroku/issues/186">#186</a>.</li>
<li>Gathering console output from <code>heroku run:detached</code> requires an external <code>heroku logs --tail</code> process that will never finish.</li>
</ol>


<p>The <a href="https://github.com/dblock/heroku-commander">heroku-commander</a> gem wraps execution of the Heroku CLI to overcome these common limitations.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/02/01/master-heroku-command-line-with-heroku-commander/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2013/01/31/create-mongodb-command-lines-with-mongo/">
      <div class="date">




  
<time datetime="2013-01-31T21:21:00-05:00" pubdate>01/31/13</time></div>
    
    
      <h1 class="entry-title">Create MongoDB Command-Lines From Mongoid Configuration</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>We use MongoDB as our primary store and have built a healthy amount of automation around various database instances and operational environments. For example, we backup databases to S3 using <code>mongodump</code>, mirror data between instances with <code>mongorestore</code> and often need to open a MongoDB shell with <code>mongo</code> to examine data at the lowest level.</p>

<p>Generating MongoDB command-lines is tedious and error-prone. Introducing a new gem called <a href="https://github.com/dblock/mongoid-shell">mongoid-shell</a> to help with this. The library can generate command-lines for various MongoDB shell tools from your Mongoid configuration.</p>

<p>For example, connect to your production MongoDB instance from a <code>db:production:shell</code> Rake task.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:db</span>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:production</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:shell</span>
</span><span class='line'>      <span class="no">Mongoid</span><span class="o">.</span><span class="n">load!</span> <span class="s2">&quot;mongoid.yml&quot;</span><span class="p">,</span> <span class="ss">:production</span>
</span><span class='line'>      <span class="nb">system</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Shell</span><span class="o">::</span><span class="no">Commands</span><span class="o">::</span><span class="no">Mongo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/01/31/create-mongodb-command-lines-with-mongo/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2013/01/20/improving-performance-of-mongoid-cached-json/">
      <div class="date">




  
<time datetime="2013-01-20T21:21:00-05:00" pubdate>01/20/13</time></div>
    
    
      <h1 class="entry-title">Improving Performance of Mongoid-Cached-Json</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last year, we have open-sourced and made extensive use of two Ruby libraries in our API: <a href="https://github.com/dblock/mongoid-cached-json">mongoid-cached-json</a> and <a href="https://github.com/artsy/garner">garner</a>. Both transform the procedural nightmare of caching and JSON generation into a declarative and easily manageable DSL. It was worth the investment, since our service spends half of its time generating JSON and reading from and writing to Memcached.</p>

<p>Today we&#8217;ve released mongoid-cached-json 1.4 with two interesting performance improvements.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/01/20/improving-performance-of-mongoid-cached-json/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2013/01/15/debugging-bundler-issues-with-heroku/">
      <div class="date">




  
<time datetime="2013-01-15T21:21:00-05:00" pubdate>01/15/13</time></div>
    
    
      <h1 class="entry-title">Debugging Bundler Issues on Heroku</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few days ago we have started seeing the Heroku deployments of one of our applications randomly hang during <code>bundle install</code>. The problem worsened with time and we were not able to do a deployment for days.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git push -f git@heroku.com:application.git FETCH_HEAD:master
</span><span class='line'>-----&gt; Deleting 12 files matching .slugignore patterns.
</span><span class='line'>-----&gt; Ruby/Rails app detected
</span><span class='line'>-----&gt; Using Ruby version: ruby-1.9.3
</span><span class='line'>-----&gt; Installing dependencies using Bundler version 1.3.0.pre.5
</span><span class='line'>       Running: bundle install --without development:test --path vendor/bundle --binstubs vendor/bundle/bin
</span><span class='line'>       Fetching gem metadata from http://rubygems.org/.......
</span><span class='line'>       Fetching gem metadata from http://rubygems.org/..
</span><span class='line'>/app/slug-compiler/lib/utils.rb:66:in `block (2 levels) in spawn': command='/app/slug-compiler/lib/../../tmp/buildpacks/ruby/bin/compile /tmp/build_1p6071sni4hh1 /app/tmp/repo.git/.cache' exit_status=0 out='' at=timeout elapsed=900.1056394577026 (Utils::TimeoutError)
</span><span class='line'>  from /app/slug-compiler/lib/utils.rb:52:in `loop'
</span><span class='line'>  from /app/slug-compiler/lib/utils.rb:52:in `block in spawn'
</span><span class='line'>  from /app/slug-compiler/lib/utils.rb:47:in `popen'
</span><span class='line'>  from /app/slug-compiler/lib/utils.rb:47:in `spawn'
</span><span class='line'>  from /app/slug-compiler/lib/buildpack.rb:37:in `block in compile'
</span><span class='line'>  from /app/slug-compiler/lib/buildpack.rb:35:in `fork'
</span><span class='line'>  from /app/slug-compiler/lib/buildpack.rb:35:in `compile'
</span><span class='line'>  from /app/slug-compiler/lib/slug.rb:497:in `block in run_buildpack'
</span><span class='line'> !     Heroku push rejected, failed to compile Ruby/rails app</span></code></pre></td></tr></table></div></figure>


<p>Seeing bundler hang on &#8220;Fetching gem metadata from http://rubygems.org/&#8221;, my immediate reaction was to blame the RubyGems Dependency API for its poor performance and attempt the <a href="http://hone.herokuapp.com/bundler%20heroku/2012/10/22/rubygems-and-the-dependency-api.html">recommended workaround</a> of switching to <em>http://bundler-api.herokuapp.com</em>. That didn&#8217;t work.</p>

<p>I also tried to reproduce the issue on a local environment, including a (what I thought was) a completely clean machine at no avail. My <code>bundle install</code> would always succeed.</p>

<p>Finally, everything pointed at an infrastructure problem with Heroku itself, so I opened a ticket (#72648), <a href="https://twitter.com/dblockdotorg/status/290221530892365824">tweeted</a> endlessly to Heroku devs, pinged a  contact at Heroku on Skype and generally annoyed people for 5 straight days. It was a frustrating problem and I was getting no useful help.</p>

<p>Fast forward, this turned out to be <a href="https://github.com/carlhuda/bundler/issues/2248">an issue in Bundler</a>. Narrowing it down would have been relatively easy if I had known where to look.</p>

<p>I hope this post helps you with similar issues.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2013/01/15/debugging-bundler-issues-with-heroku/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/12/13/beat-heroku-60-seconds-application-boot-timeout-with-a-proxy/">
      <div class="date">




  
<time datetime="2012-12-13T21:21:00-05:00" pubdate>12/13/12</time></div>
    
    
      <h1 class="entry-title">Beat Heroku&#8217;s 60 Seconds Application Boot Timeout With a Proxy</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/2012-12-13-beat-heroku-60-seconds-application-boot-timeout-with-a-proxy/heroku-logo-light-234x60.png"></p>

<p>Heroku will log an <a href="https://devcenter.heroku.com/articles/error-codes#r10-boot-timeout">R10 - Boot Timeout</a> error when a web process takes longer than 60 seconds to bind to its assigned port. This error is often caused by a process being unable to reach an external resource, such as a database or because you have a lot of gems in your <code>Gemfile</code> which take a long time to load.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Dec 12 12:12:12 prod heroku/web.1:
</span><span class='line'>  Error R10 (Boot timeout)
</span><span class='line'>  Web process failed to bind to $PORT within 60 seconds of launch</span></code></pre></td></tr></table></div></figure>


<p>There&#8217;s currently no way to increase this boot timeout, but we can beat it with a proxy implemented by our new <a href="https://github.com/dblock/heroku-forward">heroku-forward</a> gem.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/12/13/beat-heroku-60-seconds-application-boot-timeout-with-a-proxy/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/11/29/measuring-performance-in-grape-apis-with-new-relic/">
      <div class="date">




  
<time datetime="2012-11-29T21:21:00-05:00" pubdate>11/29/12</time></div>
    
    
      <h1 class="entry-title">Measuring Performance in Grape APIs With NewRelic RPM</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>Knowing how well your API performs in real time is essential to any successful project. That&#8217;s because you can&#8217;t fix what you can&#8217;t measure.</p>

<p>We use and heavily contribute to <a href="http://github.com/intridea/grape">Grape</a>, a Ruby API DSL. Grape is a Rack middleware and we have been reporting API performance data to <a href="http://newrelic.com/">NewRelic</a> with code from <a href="http://code.dblock.org/new-relic-performance-instrumentation-with-grape-api">my older blog post</a>.</p>

<p>It&#8217;s time to improve the reporting implementation and address performance monitoring in both development and production environments. Here&#8217;s what a single API request breakdown is going to look like.</p>

<p><img src="/images/2012-11-29-measuring-performance-in-grape-apis-with-new-relic/transaction-detail.png"></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/11/29/measuring-performance-in-grape-apis-with-new-relic/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/11/22/friendly-urls-with-mongoid-slug/">
      <div class="date">




  
<time datetime="2012-11-22T21:21:00-05:00" pubdate>11/22/12</time></div>
    
    
      <h1 class="entry-title">Friendly URLs With Mongoid::Slug</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>All Artsy URLs shared publicly are humanly readable. For example, you&#8217;ll find all Barbara Kruger&#8217;s works at <a href="http://artsy.net/artist/barbara-kruger">artsy.net/artist/barbara-kruger</a> and a post by Hyperallergic entitled &#8220;Superfluous Men Can&#8217;t Get No Satisfaction&#8221; at <a href="http://artsy.net/hyperallergic/post/superfluous-men-cant-get-no-satisfaction">artsy.net/hyperallergic/post/superfluous-men-cant-get-no-satisfaction</a>. This is a lot prettier than having <code>id=42</code> in the browser&#8217;s address and is a big improvement for SEO.</p>

<p><img src="/images/2012-11-22-friendly-urls-with-mongoid-slug/barbara-kruger.png"></p>

<p>We construct these URLs with a gem called <a href="https://github.com/digitalplaywright/mongoid-slug">mongoid_slug</a>. Interesting implementation details under the cut.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/11/22/friendly-urls-with-mongoid-slug/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
    <a href="/blog/2012/11/15/how-to-monitor-503s-and-timeout-on-heroku/">
      <div class="date">




  
<time datetime="2012-11-15T21:21:00-05:00" pubdate>11/15/12</time></div>
    
    
      <h1 class="entry-title">How to Monitor 503s and Timeout Requests on Heroku</h1>

    
    </a>
    
      <p class="meta">
        
      </p>
    
  </header>


  <div class="entry-content"><p>We have recently started hitting an unusually high number of &#8220;503: Service Unavailable&#8221; errors with one of our applications on Heroku. What are these? How can we monitor their quantity and frequency? What&#8217;s the fix?</p>

<p><img src="/images/2012-11-15-how-to-monitor-503s-and-timeout-on-heroku/503-error.png"></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/blog/2012/11/15/how-to-monitor-503s-and-timeout-on-heroku/">Read on &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
    </div>
    <div id="sidebar">
      
  
    <section>
  <h1>Info</h1>
  <ul>
    <li> <a href="/about">About Us</a></li>
    <li> <a href="/open-source">Artsy Open-Source</a></li>
    <li> <a href="http://artsy.net/job/developer">Join the Artsy Engineering Team</a></li>
  </ul>
</section>
<section id="recent_posts_section">
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/11/07/upgrading-to-mongoid4/">Upgrading to Mongoid 4.x</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/27/introduction-to-aws-opsworks/">Introduction to AWS OpsWorks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/23/normalizing-gmail-email-addresses-with-canonical-emails/">Normalizing GMail E-Mail Addresses with CanonicalEmails</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/21/adding-api-documentation-with-grape-swagger/">Adding API Docs with Grape and Swagger</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/14/writing-headless-backbone-tests-with-node-dot-js/">Writing Headless Backbone Tests With Node.js</a>
      </li>
    
  </ul>
  <a class="archive_link" href="/blog/archives">Blog Archive</a>
</section>
<section>
  <h1>Search</h1>
  <form action="http://google.com/search" method="get">
    <input type="hidden" name="q" value="site:artsy.github.io" />
    <input class="search" type="text" name="q" results="0" />
  </form>
</section>
  


    </div>
  </div>
  <footer id="main_footer"><p>
  Copyright &copy; 2013 - Artsy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'artsy';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
